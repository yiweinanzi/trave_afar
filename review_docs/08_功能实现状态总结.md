# åŠŸèƒ½å®ç°çŠ¶æ€æ€»ç»“

> æœ€åæ›´æ–°: 2025-01-XX  
> çŠ¶æ€: âœ… **æ‰€æœ‰åŠŸèƒ½å·²å®ç°ï¼**

---

## ğŸ“‹ å®ç°çŠ¶æ€æ€»è§ˆ

| åŠŸèƒ½æ¨¡å— | åŠŸèƒ½é¡¹ | çŠ¶æ€ | å®ç°æ–‡ä»¶ | è¯´æ˜ |
|---------|--------|------|----------|------|
| **è¯­ä¹‰å¬å›** | ColBERTç›¸ä¼¼åº¦è®¡ç®— | âœ… å·²å®ç° | `bge_m3_encoder.py` | å¤šå‘é‡äº¤äº’è®¡ç®— |
| **æ„å›¾ç†è§£** | LLMè°ƒç”¨é€»è¾‘ | âœ… å·²å®ç° | `intent_understanding.py` | å¤ç”¨llm_generator |
| **é‡æ’åº** | LLMè°ƒç”¨é€»è¾‘ | âœ… å·²å®ç° | `llm_reranker.py` | å¤ç”¨llm_generator |
| **POIç¼–ç ** | LLMæ‰¹é‡å¤„ç† | âœ… å·²å®ç° | `item_encoding.py` | LLMæ‰¹é‡ç¼–ç  |
| **POIå¢å¼º** | LLMæè¿°å¢å¼º | âœ… å·²å®ç° | `item_encoding.py` | LLMç”Ÿæˆå¢å¼ºæè¿° |
| **æ–‡æ¡ˆç”Ÿæˆ** | DPOè®­ç»ƒè„šæœ¬ | âœ… å·²å®ç° | `train_dpo.py` | TRL DPOTrainer |
| **æ–‡æ¡ˆç”Ÿæˆ** | åå¥½æ•°æ®æ„é€  | âœ… å·²å®ç° | `make_prefs.py` | åå¥½å¯¹ç”Ÿæˆ |

---

## ğŸ”§ å®ç°è¯¦æƒ…

### 1. ColBERTç›¸ä¼¼åº¦è®¡ç®— âœ…

**æ–‡ä»¶**: `src/embedding/bge_m3_encoder.py`  
**ä½ç½®**: ç¬¬135-155è¡Œ  
**æ–¹æ³•**: `compute_similarity(method='colbert')`

**å®ç°é€»è¾‘**:
```python
# ColBERT: å¤šå‘é‡äº¤äº’
# query_vecs: (seq_len, dim)
# corpus_vecs: (n_docs, seq_len, dim)
# è®¡ç®—æ¯ä¸ªquery tokenä¸docçš„æœ€å¤§ç›¸ä¼¼åº¦ï¼Œç„¶åæ±‚å’Œ
```

**ä½¿ç”¨æ–¹å¼**:
```python
query_emb = encoder.encode_query(query, return_colbert=True)
corpus_emb = encoder.encode_texts(texts, return_colbert=True)
scores = encoder.compute_similarity(query_emb, corpus_emb, method='colbert')
```

---

### 2. LLMæ„å›¾ç†è§£è°ƒç”¨ âœ…

**æ–‡ä»¶**: `src/llm4rec/intent_understanding.py`  
**ä½ç½®**: ç¬¬176-235è¡Œ  
**æ–¹æ³•**: `_call_llm()`

**å®ç°ç‰¹ç‚¹**:
- æ”¯æŒLLMGeneratorå®ä¾‹ï¼ˆtokenizer + modelï¼‰
- æ”¯æŒæœ‰generateæ–¹æ³•çš„æ¨¡å‹
- æ”¯æŒæœ‰chatæ–¹æ³•çš„APIæ¨¡å‹
- è‡ªåŠ¨é”™è¯¯å¤„ç†å’Œé™çº§

**ä½¿ç”¨æ–¹å¼**:
```python
from content_generation.llm_generator import LLMGenerator
llm_model = LLMGenerator(model_type='qwen', use_api=False)
intent_module = IntentUnderstandingModule(llm_model=llm_model, use_template=False)
intent = intent_module.understand(query)
```

---

### 3. LLMé‡æ’åºè°ƒç”¨ âœ…

**æ–‡ä»¶**: `src/llm4rec/llm_reranker.py`  
**ä½ç½®**: ç¬¬160-219è¡Œ  
**æ–¹æ³•**: `_call_llm()`

**å®ç°ç‰¹ç‚¹**:
- å¤ç”¨llm_generatorä¸­çš„LLMè°ƒç”¨é€»è¾‘
- æ”¯æŒå¤šç§LLMæ¨¡å‹ç±»å‹
- è‡ªåŠ¨é”™è¯¯å¤„ç†å’Œé™çº§

**ä½¿ç”¨æ–¹å¼**:
```python
from content_generation.llm_generator import LLMGenerator
llm_model = LLMGenerator(model_type='qwen', use_api=False)
reranker = LLMReranker(llm_model=llm_model, use_template=False)
reranked = reranker.rerank(candidates, intent, topk=20)
```

---

### 4. LLMæ‰¹é‡å¤„ç†POIæè¿° âœ…

**æ–‡ä»¶**: `src/llm4rec/item_encoding.py`  
**ä½ç½®**: ç¬¬68-133è¡Œ  
**æ–¹æ³•**: `_llm_encoding()`

**å®ç°ç‰¹ç‚¹**:
- æ‰¹é‡å¤„ç†POIæè¿°
- æå–poi_typeã€difficultyã€highlights
- è‡ªåŠ¨é”™è¯¯å¤„ç†å’Œé™çº§

**ä½¿ç”¨æ–¹å¼**:
```python
from content_generation.llm_generator import LLMGenerator
llm_model = LLMGenerator(model_type='qwen', use_api=False)
encoder = POIEncodingModule(llm_model=llm_model, use_template=False)
enhanced_df = encoder.encode_poi_features(poi_df)
```

---

### 5. LLMå¢å¼ºPOIæè¿° âœ…

**æ–‡ä»¶**: `src/llm4rec/item_encoding.py`  
**ä½ç½®**: ç¬¬167-211è¡Œ  
**æ–¹æ³•**: `POIEnhancer.enhance_description()`

**å®ç°ç‰¹ç‚¹**:
- ä½¿ç”¨LLMç”Ÿæˆå¸å¼•äººçš„æè¿°
- è‡ªåŠ¨é”™è¯¯å¤„ç†å’Œé™çº§

**ä½¿ç”¨æ–¹å¼**:
```python
from content_generation.llm_generator import LLMGenerator
llm_model = LLMGenerator(model_type='qwen', use_api=False)
enhanced_desc = POIEnhancer.enhance_description(
    poi_name="å–€çº³æ–¯æ¹–",
    original_desc="æ–°ç–†è‘—åæ¹–æ³Š",
    llm_model=llm_model
)
```

---

### 6. DPOè®­ç»ƒè„šæœ¬ âœ…

**æ–‡ä»¶**: `src/content_generation/train_dpo.py`  
**æ–‡ä»¶**: `src/content_generation/make_prefs.py`

**å®ç°ç‰¹ç‚¹**:
- ä½¿ç”¨TRLçš„DPOTrainer
- æ”¯æŒLoRAå¾®è°ƒ
- è‡ªåŠ¨æ£€æµ‹æœ¬åœ°æ¨¡å‹è·¯å¾„
- å®Œæ•´çš„æ•°æ®é¢„å¤„ç†

**ä½¿ç”¨æ–¹å¼**:
```bash
# 1. æ„é€ åå¥½æ•°æ®
python src/content_generation/make_prefs.py

# 2. è®­ç»ƒDPOæ¨¡å‹
python src/content_generation/train_dpo.py \
    --model /root/autodl-tmp/goafar_project/models/models--Qwen--Qwen3-8B \
    --prefs outputs/dpo/prefs.csv \
    --output outputs/dpo/run \
    --use-lora \
    --lora-r 16 \
    --lora-alpha 16 \
    --lr 1e-5 \
    --epochs 1
```

---

## ğŸ¯ æ¨¡å‹è·¯å¾„é…ç½®

**Qwen3-8Bæ¨¡å‹è·¯å¾„**: `/root/autodl-tmp/goafar_project/models/models--Qwen--Qwen3-8B`

**è‡ªåŠ¨æ£€æµ‹é€»è¾‘**:
- ä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ¨¡å‹è·¯å¾„
- å¦‚æœæœ¬åœ°ä¸å­˜åœ¨ï¼Œå›é€€åˆ°HuggingFaceæ¨¡å‹åç§°
- æ‰€æœ‰LLMç›¸å…³æ¨¡å—å·²æ›´æ–°æ¨¡å‹è·¯å¾„æ£€æµ‹

**å·²æ›´æ–°çš„æ–‡ä»¶**:
- `src/content_generation/llm_generator.py`
- `src/content_generation/train_dpo.py`
- `src/llm4rec/qwen_recommender.py`

---

## âœ… ç³»ç»ŸçŠ¶æ€

### å®Œå…¨å¯ç”¨çš„åŠŸèƒ½

1. **è¯­ä¹‰æ£€ç´¢**: âœ… Dense/Sparse/ColBERTä¸‰ç§æ¨¡å¼
2. **æ„å›¾ç†è§£**: âœ… æ¨¡æ¿æ¨¡å¼ + LLMæ¨¡å¼
3. **é‡æ’åº**: âœ… è§„åˆ™é‡æ’ + LLMé‡æ’
4. **POIç¼–ç **: âœ… æ¨¡æ¿ç¼–ç  + LLMç¼–ç 
5. **POIå¢å¼º**: âœ… LLMæè¿°å¢å¼º
6. **æ–‡æ¡ˆç”Ÿæˆ**: âœ… æ¨¡æ¿ç”Ÿæˆ + LLMç”Ÿæˆ + DPOå¾®è°ƒ

### é™çº§ç­–ç•¥

æ‰€æœ‰LLMç›¸å…³åŠŸèƒ½éƒ½æœ‰å®Œå–„çš„é™çº§ç­–ç•¥ï¼š
- LLMå¤±è´¥ â†’ æ¨¡æ¿/è§„åˆ™æ¨¡å¼
- ä¿è¯ç³»ç»Ÿå¯ç”¨æ€§
- ä¸å½±å“æ ¸å¿ƒæµç¨‹

---

## ğŸ“ ä½¿ç”¨å»ºè®®

### å¼€å‘ç¯å¢ƒ
- ä½¿ç”¨æ¨¡æ¿æ¨¡å¼ï¼šå¿«é€Ÿã€ç¨³å®šã€æ— éœ€GPU
- é€‚åˆï¼šå¿«é€Ÿæµ‹è¯•ã€æ¼”ç¤ºã€å¼€å‘

### ç”Ÿäº§ç¯å¢ƒ
- ä½¿ç”¨LLMæ¨¡å¼ï¼šæ•ˆæœæ›´å¥½ã€ä¸ªæ€§åŒ–
- éœ€è¦ï¼šGPUã€Qwen3-8Bæ¨¡å‹
- æ¨¡å‹è·¯å¾„ï¼š`/root/autodl-tmp/goafar_project/models/models--Qwen--Qwen3-8B`

### DPOè®­ç»ƒ
- éœ€è¦ï¼šåå¥½æ•°æ®ã€GPU
- è®­ç»ƒæ—¶é—´ï¼š1-2å°æ—¶ï¼ˆå–å†³äºæ•°æ®é‡ï¼‰
- è¾“å‡ºï¼šå¾®è°ƒåçš„æ¨¡å‹æƒé‡

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [æœªå®ç°åŠŸèƒ½æ¸…å•.md](æœªå®ç°åŠŸèƒ½æ¸…å•.md) - è¯¦ç»†å®ç°è¯´æ˜
- [05_æ–‡æ¡ˆç”Ÿæˆ_DPO.md](05_æ–‡æ¡ˆç”Ÿæˆ_DPO.md) - DPOè®­ç»ƒè¯¦è§£
- [03_å€™é€‰èåˆä¸LLMé‡æ’.md](03_å€™é€‰èåˆä¸LLMé‡æ’.md) - LLMé‡æ’è¯¦è§£
- [01_è¯­ä¹‰å¬å›_BGE-M3.md](01_è¯­ä¹‰å¬å›_BGE-M3.md) - ColBERTè¯¦è§£

---

**æœ€åæ›´æ–°**: 2025-01-XX  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**çŠ¶æ€**: âœ… **æ‰€æœ‰åŠŸèƒ½å·²å®ç°ï¼ç³»ç»Ÿå®Œå…¨å¯ç”¨ï¼**

