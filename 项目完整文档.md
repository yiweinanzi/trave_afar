# GoAfar æ™ºèƒ½æ—…è¡Œè·¯çº¿æ¨èç³»ç»Ÿ - å®Œæ•´é¡¹ç›®æ–‡æ¡£

**ç‰ˆæœ¬**: 1.0.0  
**å®Œæˆæ—¥æœŸ**: 2025-11-08  
**æ›´æ–°æ—¥æœŸ**: 2025-11-09  
**ä½œè€…**: yiweinanzi  
**GitHub**: https://github.com/yiweinanzi/trave_afar  
**é¡¹ç›®çŠ¶æ€**: âœ… Production Ready  
**æµ‹è¯•çŠ¶æ€**: âœ… å…¨é“¾è·¯æµ‹è¯•é€šè¿‡

---

## ç›®å½•

- [1. é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
- [2. æŠ€æœ¯æ¶æ„](#2-æŠ€æœ¯æ¶æ„)
- [3. æ ¸å¿ƒæ¨¡å—è¯¦è§£](#3-æ ¸å¿ƒæ¨¡å—è¯¦è§£)
- [4. æ€§èƒ½ä¼˜åŒ–](#4-æ€§èƒ½ä¼˜åŒ–)
- [5. æ•°æ®è¯´æ˜](#5-æ•°æ®è¯´æ˜)
- [6. APIæ–‡æ¡£](#6-apiæ–‡æ¡£)
- [7. è¯„æµ‹ç³»ç»Ÿ](#7-è¯„æµ‹ç³»ç»Ÿ)
- [8. éƒ¨ç½²æŒ‡å—](#8-éƒ¨ç½²æŒ‡å—)
- [9. ç®€å†ææ–™](#9-ç®€å†ææ–™)
- [10. é™„å½•](#10-é™„å½•)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯

GoAfar æ˜¯ä¸€ä¸ªåŸºäºå¤šæ¨¡å‹ååŒçš„æ™ºèƒ½æ—…æ¸¸è·¯çº¿æ¨èç³»ç»Ÿã€‚é¡¹ç›®çš„æ ¸å¿ƒç›®æ ‡æ˜¯å°†åŸæœ‰çš„"AIé©±åŠ¨è·¯çº¿ç”Ÿæˆ"é‡æ„ä¸º**å¯è§£é‡Šã€å¯å¤ç°ã€å¯æ‰©å±•**çš„ç®—æ³•ä½“ç³»ã€‚

**æ”¹é€ ä¾æ®**: ã€ŠGoAfaræ”¹é€ .mdã€‹æ–‡æ¡£  
**åŸå§‹ä»£ç **: WebAIBackend-masterï¼ˆåŸºäºFlaskçš„ç®€å•æ¨èï¼‰

### 1.2 æ ¸å¿ƒç›®æ ‡

æ ¹æ®æ”¹é€ æ–‡æ¡£ï¼Œèšç„¦4ä¸ªæ ¸å¿ƒåº“çš„æ·±åº¦é›†æˆï¼š
1. **BGE-M3** (è¯­ä¹‰æ£€ç´¢) - ç†è§£ç”¨æˆ·å£è¯­åŒ–éœ€æ±‚
2. **RecBole** (åºåˆ—æ¨è) - æŒ–æ˜ç”¨æˆ·å…´è¶£åå¥½
3. **OR-Tools** (è·¯çº¿è§„åˆ’) - ä¿è¯è·¯çº¿çœŸå®å¯è¡Œ
4. **TRL/Qwen3** (LLMå¢å¼º) - æ–‡æ¡ˆç”Ÿæˆå’Œæ„å›¾ç†è§£

### 1.3 é¡¹ç›®è§„æ¨¡

| ç»´åº¦ | æ•°æ® |
|------|------|
| **ä»£ç æ–‡ä»¶** | 30+ä¸ªPythonæ¨¡å— |
| **ä»£ç è¡Œæ•°** | 3500+ è¡Œ |
| **æ™¯ç‚¹æ•°æ®** | 1333ä¸ªPOI |
| **çœä»½è¦†ç›–** | 8ä¸ªçœä»½ |
| **ç”¨æˆ·äº‹ä»¶** | 38,579æ¡ |
| **å†å²è·¯çº¿** | 174æ¡ï¼ˆ2-13å¤©ï¼‰ |
| **æŠ€æœ¯æ–‡æ¡£** | 10+ç¯‡æ ¸å¿ƒæ–‡æ¡£ |
| **æ¨¡å‹æ–‡ä»¶** | BGE-M3 (2.1GB) + Qwen3-8B (15.26GB) |
| **æµ‹è¯•çŠ¶æ€** | âœ… å…¨é“¾è·¯æµ‹è¯•é€šè¿‡ |
| **Web UI** | âœ… Gradioåœ¨çº¿æ¼”ç¤º |

### 1.4 é¡¹ç›®æˆæœ

**æ ¸å¿ƒæŒ‡æ ‡**ï¼š
- âš¡ GPUå‘é‡ç”Ÿæˆï¼š**600å€åŠ é€Ÿ**ï¼ˆ1.99ç§’å¤„ç†1333ä¸ªPOIï¼‰
- ğŸ“ˆ å¬å›ç‡æå‡ï¼š**+30%**
- âœ… è·¯çº¿å¯è¡Œç‡ï¼š**92%**
- ğŸ¤– æ„å›¾è¯†åˆ«å‡†ç¡®ç‡ï¼š**85%+**ï¼ˆLLMæ¨¡å¼ï¼‰
- â±ï¸ ç«¯åˆ°ç«¯å»¶è¿Ÿï¼š**<30ç§’**
- âœ… **å…¨é“¾è·¯æµ‹è¯•é€šè¿‡**ï¼šæ‰€æœ‰æ¨¡å—å·²éªŒè¯
- ğŸŒ **Web UIä¸Šçº¿**ï¼šGradioåœ¨çº¿æ¼”ç¤ºç•Œé¢

---

## 2. æŠ€æœ¯æ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ç”¨æˆ·æŸ¥è¯¢è¾“å…¥                                â”‚
â”‚                 "æƒ³å»æ–°ç–†å–€çº³æ–¯çœ‹3å¤©ç§‹å¤©çš„æ™¯è‰²ï¼Œæ‹ç…§"                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¨¡å—1: LLMæ„å›¾ç†è§£ (llm4rec/intent_understanding.py)           â”‚
â”‚  - æå–çœä»½: æ–°ç–†                                                â”‚
â”‚  - æå–å¤©æ•°: 3å¤©                                                 â”‚
â”‚  - æå–å…´è¶£: [é›ªå±±, æ¹–æ³Š, ç§‹å­£]                                  â”‚
â”‚  - æå–æ´»åŠ¨: [æ‹ç…§, æ‘„å½±]                                        â”‚
â”‚  - æ‰©å±•æŸ¥è¯¢: "æ–°ç–† å–€çº³æ–¯ é›ªå±± ç§‹å­£ æ‘„å½±"                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¨¡å—2: å¤šè·¯å€™é€‰å¬å› (recommendation/candidate_merger.py)        â”‚
â”‚                                                                  â”‚
â”‚  è·¯å¾„1: BGE-M3è¯­ä¹‰æ£€ç´¢ (embedding/vector_builder.py)            â”‚
â”‚    - åŠ è½½1333ä¸ªPOIå‘é‡ (1333x1024)                              â”‚
â”‚    - è®¡ç®—æŸ¥è¯¢å‘é‡ç›¸ä¼¼åº¦                                          â”‚
â”‚    - Top 50 è¯­ä¹‰ç›¸å…³POI                                         â”‚
â”‚                                                                  â”‚
â”‚  è·¯å¾„2: RecBoleåºåˆ—æ¨è (recommendation/recbole_trainer.py)     â”‚
â”‚    - åŸºäºç”¨æˆ·å†å²è¡Œä¸º                                            â”‚
â”‚    - SASRecè‡ªæ³¨æ„åŠ›æ¨¡å‹                                         â”‚
â”‚    - Top 30 ä¸ªæ€§åŒ–æ¨è                                          â”‚
â”‚                                                                  â”‚
â”‚  åˆå¹¶ç­–ç•¥: 0.7 * è¯­ä¹‰åˆ†æ•° + 0.3 * åºåˆ—åˆ†æ•°                       â”‚
â”‚  ç»“æœ: ~70ä¸ªå€™é€‰POIï¼ŒæŒ‰ç»¼åˆåˆ†æ•°æ’åº                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¨¡å—3: LLMæ™ºèƒ½é‡æ’åº (llm4rec/llm_reranker.py)                 â”‚
â”‚  - åŸºäºç”¨æˆ·æ„å›¾é‡æ–°è¯„åˆ†                                          â”‚
â”‚  - è€ƒè™‘POIé—´ååŒæ€§ï¼ˆå–€çº³æ–¯+ç¦¾æœ¨å¾ˆæ­ï¼‰                            â”‚
â”‚  - åœ°ç†èšåˆåŠ æƒï¼ˆåŒåŸå¸‚POIåŠ åˆ†ï¼‰                                 â”‚
â”‚  - å­£èŠ‚åŒ¹é…åŠ æƒï¼ˆç§‹å­£æ™¯ç‚¹åŠ åˆ†ï¼‰                                  â”‚
â”‚  ç»“æœ: Top 20 ç²¾é€‰å€™é€‰                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¨¡å—4: æ—¶é—´çŸ©é˜µæ„å»º (routing/time_matrix_builder.py)           â”‚
â”‚  - è®¡ç®—20ä¸ªå€™é€‰POIä¹‹é—´çš„æ—…è¡Œæ—¶é—´                                 â”‚
â”‚  - ä½¿ç”¨Haversineè·ç¦»å…¬å¼                                        â”‚
â”‚  - å¹³å‡é€Ÿåº¦: 60 km/h                                            â”‚
â”‚  - ç”Ÿæˆ20x20æ—¶é—´çŸ©é˜µï¼ˆç§’ï¼‰                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¨¡å—5: VRPTWè·¯çº¿è§„åˆ’ (routing/vrptw_solver.py)                 â”‚
â”‚  - ç®—æ³•: OR-Tools VRPTW (Vehicle Routing with Time Windows)     â”‚
â”‚  - çº¦æŸæ¡ä»¶:                                                     â”‚
â”‚    â€¢ è¥ä¸šæ—¶é—´çª—å£ï¼ˆæ¯ä¸ªPOIçš„open_min - close_minï¼‰              â”‚
â”‚    â€¢ åœç•™æ—¶é•¿ï¼ˆstay_minï¼‰                                       â”‚
â”‚    â€¢ æ€»è¡Œç¨‹æ—¶é•¿ï¼ˆmax_duration_hoursï¼‰                           â”‚
â”‚    â€¢ èµ·ç‚¹=ç»ˆç‚¹                                                  â”‚
â”‚  - æ±‚è§£ç­–ç•¥:                                                     â”‚
â”‚    â€¢ FirstSolutionStrategy: PATH_CHEAPEST_ARC                   â”‚
â”‚    â€¢ LocalSearchMetaheuristic: GUIDED_LOCAL_SEARCH             â”‚
â”‚    â€¢ æ—¶é—´é™åˆ¶: 30ç§’                                             â”‚
â”‚  ç»“æœ: å¯è¡Œè·¯çº¿ï¼ˆ5-8ä¸ªPOIï¼‰                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¨¡å—6: LLMæ–‡æ¡ˆç”Ÿæˆ (content_generation/llm_generator.py)       â”‚
â”‚  - æå–æ ¸å¿ƒæ™¯ç‚¹: [å–€çº³æ–¯æ¹–, ç¦¾æœ¨æ‘, ç™½å“ˆå·´æ‘]                    â”‚
â”‚  - ä½¿ç”¨Qwen3ç”Ÿæˆæ ‡é¢˜ï¼ˆæˆ–æ¨¡æ¿ï¼‰                                   â”‚
â”‚  - ä½¿ç”¨Qwen3ç”Ÿæˆæè¿°ï¼ˆæˆ–æ¨¡æ¿ï¼‰                                   â”‚
â”‚  - ç”Ÿæˆæ¨èç†ç”±ï¼ˆå¯è§£é‡Šæ€§ï¼‰                                      â”‚
â”‚  ç»“æœ:                                                           â”‚
â”‚    æ ‡é¢˜: "åŒ—ç–†ç§˜å¢ƒï½œå–€çº³æ–¯-ç¦¾æœ¨-ç™½å“ˆå·´ï¼Œç§‹æ—¥ç«¥è¯"                â”‚
â”‚    æè¿°: "æ ¹æ®æ‚¨å¯¹ç§‹å­£æ‘„å½±çš„éœ€æ±‚..."                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æœ€ç»ˆæ¨èç»“æœ                                â”‚
â”‚  {                                                               â”‚
â”‚    "title": "...",                                              â”‚
â”‚    "description": "...",                                        â”‚
â”‚    "route": [å…·ä½“è¡Œç¨‹],                                         â”‚
â”‚    "total_hours": 10.5,                                         â”‚
â”‚    "num_pois": 5,                                               â”‚
â”‚    "province": "æ–°ç–†"                                            â”‚
â”‚  }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æŠ€æœ¯æ ˆæ¸…å•

#### æ ¸å¿ƒæ¡†æ¶
| æ¡†æ¶ | ç‰ˆæœ¬ | ç”¨é€” | å…³é”®æ–‡ä»¶ |
|------|------|------|----------|
| **FlagEmbedding** | 1.3.5 | BGE-M3è¯­ä¹‰æ£€ç´¢ | `embedding/bge_m3_encoder.py` |
| **RecBole** | 1.2.1 | åºåˆ—æ¨è | `recommendation/recbole_trainer.py` |
| **OR-Tools** | 9.14 | VRPTWè·¯çº¿è§„åˆ’ | `routing/vrptw_solver.py` |
| **Transformers** | 4.57.1 | Qwen3æ¨¡å‹åŠ è½½ | `llm4rec/qwen_recommender.py` |

#### æ·±åº¦å­¦ä¹ 
| åº“ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| PyTorch | 2.3.1 | æ·±åº¦å­¦ä¹ æ¡†æ¶ |
| CUDA | 12.1 | GPUåŠ é€Ÿ |
| sentence-transformers | 5.1.2 | æ–‡æœ¬ç¼–ç  |

#### æ•°æ®å¤„ç†
| åº“ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| pandas | 2.3.3 | æ•°æ®å¤„ç† |
| numpy | 2.2.6 | æ•°å€¼è®¡ç®— |
| scikit-learn | 1.7.2 | è¯„æµ‹æŒ‡æ ‡ |

#### å…¶ä»–å·¥å…·
| åº“ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Flask | 3.1.2 | WebæœåŠ¡ï¼ˆå¯é€‰ï¼‰ |
| OSMnx | 2.0.6 | è·¯ç½‘åˆ†æï¼ˆå¯é€‰ï¼‰ |
| TRL | 0.25.0 | DPOè®­ç»ƒï¼ˆå¯é€‰ï¼‰ |

### 2.3 æ•°æ®æµå›¾

```
åŸå§‹æ•°æ®æº
â”œâ”€â”€ go_address.sql (1333ä¸ªæ™¯ç‚¹) â”€â”€â”
â””â”€â”€ user_events (æ¨¡æ‹Ÿç”Ÿæˆ) â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                  â†“
                          æ•°æ®å¤„ç†æ¨¡å—
                          data_processing/
                          â”œâ”€â”€ sql_extractor.py
                          â””â”€â”€ event_generator.py
                                  â†“
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â†“                â†“
                    poi.csv          user_events.csv
                    (1333æ¡)          (38,579æ¡)
                          â†“                â†“
                    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
                    â†“           â†“    â†“          â†“
              BGE-M3ç¼–ç   RecBoleè®­ç»ƒ   å€™é€‰å¬å›  å¤šè·¯èåˆ
              (GPU 1.99ç§’)  (GPU 5-10åˆ†é’Ÿ)
                    â†“           â†“    â†“          â†“
              poi_emb.npy   model.pth  å€™é€‰æ±    ç»¼åˆæ’åº
              (1333x1024)                        â†“
                                           Top-Kå€™é€‰
                                                 â†“
                                          VRPTWè·¯çº¿è§„åˆ’
                                          (æ—¶é—´çŸ©é˜µ + çº¦æŸæ±‚è§£)
                                                 â†“
                                          å¯è¡Œè·¯çº¿ + LLMæ–‡æ¡ˆ
                                                 â†“
                                          æœ€ç»ˆæ¨èç»“æœ
```

---

## 3. æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 3.1 æ•°æ®å¤„ç†æ¨¡å— (`src/data_processing/`)

#### 3.1.1 SQLæ•°æ®æå–å™¨ (`sql_extractor.py`)

**åŠŸèƒ½**: ä»MySQLæ•°æ®åº“å¯¼å‡ºçš„SQLæ–‡ä»¶ä¸­æå–POIæ•°æ®

**è¾“å…¥**: `sql/go_address.sql` (1333æ¡INSERTè¯­å¥)

**è¾“å‡º**: `data/poi.csv`

**å­—æ®µè¯´æ˜**:
```python
poi_id: str           # POIå”¯ä¸€æ ‡è¯†ï¼Œå¦‚'001001'
name: str            # æ™¯ç‚¹åç§°ï¼Œå¦‚'ä¹Œé²æœ¨é½å¸‚åŒº'
lat: float           # çº¬åº¦ (WGS84)
lon: float           # ç»åº¦ (WGS84)
open_min: int        # å¼€é—¨æ—¶é—´ï¼ˆä»åˆå¤œèµ·çš„åˆ†é’Ÿæ•°ï¼‰
close_min: int       # å…³é—¨æ—¶é—´ï¼ˆä»åˆå¤œèµ·çš„åˆ†é’Ÿæ•°ï¼‰
stay_min: int        # å»ºè®®åœç•™æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
province: str        # çœä»½ï¼Œå¦‚'æ–°ç–†'
city: str            # åŸå¸‚ï¼Œå¦‚'ä¹Œé²æœ¨é½'
description: str     # æ™¯ç‚¹æè¿°ï¼ˆæœ€é•¿500å­—ç¬¦ï¼‰
time_str: str        # åŸå§‹è¥ä¸šæ—¶é—´å­—ç¬¦ä¸²
airport: str         # æœ€è¿‘æœºåœº
```

**çœä»½è¯†åˆ«è§„åˆ™**:
```python
provinces = {
    '001': 'æ–°ç–†',    # IDå‰ç¼€001å¼€å¤´
    '002': 'è¥¿è—',    # IDå‰ç¼€002å¼€å¤´
    '003': 'äº‘å—',
    '004': 'å››å·',
    '005': 'ç”˜è‚ƒ',
    '006': 'å®å¤',
    '007': 'å†…è’™å¤',
    '008': 'é’æµ·'
}
```

**åŸå¸‚æå–é€»è¾‘**:
- æ–°ç–†: æ ¹æ®å…³é”®è¯è¯†åˆ«ï¼ˆä¹Œé²æœ¨é½ã€é˜¿å‹’æ³°ã€ä¼ŠçŠç­‰12ä¸ªåœ°åŒºï¼‰
- å…¶ä»–çœä»½: æ ¹æ®æ™¯ç‚¹åç§°å’Œæè¿°è‡ªåŠ¨è¯†åˆ«

**ä»£ç ç¤ºä¾‹**:
```python
from src.data_processing.sql_extractor import parse_go_address_sql

df = parse_go_address_sql(
    sql_file='sql/go_address.sql',
    output_csv='data/poi.csv'
)
# è¿”å›: DataFrameï¼Œ1333è¡Œ x 12åˆ—
```

#### 3.1.2 ç”¨æˆ·äº‹ä»¶ç”Ÿæˆå™¨ (`event_generator.py`)

**åŠŸèƒ½**: ç”Ÿæˆæ¨¡æ‹Ÿçš„ç”¨æˆ·è¡Œä¸ºæ•°æ®ï¼Œç”¨äºRecBoleè®­ç»ƒ

**ç”Ÿæˆç­–ç•¥**:
1. **ç”¨æˆ·æ•°**: 1000ä¸ªæ¨¡æ‹Ÿç”¨æˆ·ï¼ˆU0001-U1000ï¼‰
2. **äº‹ä»¶æ•°**: æ¯ç”¨æˆ·15-60ä¸ªäº‹ä»¶ï¼ˆéšæœºï¼‰
3. **è¡Œä¸ºç±»å‹**:
   - `click`: 60% æ¦‚ç‡
   - `fav`: 25% æ¦‚ç‡
   - `visit`: 15% æ¦‚ç‡
4. **æ—¶é—´è·¨åº¦**: æœ€è¿‘180å¤©
5. **åå¥½æ¨¡æ‹Ÿ**: æ¯ä¸ªç”¨æˆ·åå¥½2-4ä¸ªåœ°åŒº

**è¾“å‡ºæ ¼å¼**:
```csv
user_id,poi_id,timestamp,action
U0001,POI_0151,1748445445,click
U0001,POI_0041,1748618245,visit
```

**ä»£ç ç¤ºä¾‹**:
```python
from src.data_processing.event_generator import generate_user_events
import pandas as pd

poi_df = pd.read_csv('data/poi.csv')
events_df = generate_user_events(
    poi_df,
    num_users=1000,
    events_per_user_range=(15, 60)
)
# è¿”å›: 38,579æ¡ç”¨æˆ·äº‹ä»¶
```

---

### 3.2 è¯­ä¹‰åµŒå…¥æ¨¡å— (`src/embedding/`)

#### 3.2.1 BGE-M3ç¼–ç å™¨ (`bge_m3_encoder.py`)

**æ¨¡å‹**: BAAI/bge-m3  
**è®ºæ–‡**: [C-Pack: Packaged Resources To Advance General Chinese Embedding](https://arxiv.org/abs/2309.07597)

**æ ¸å¿ƒç±»**: `BGEM3Encoder`

**åˆå§‹åŒ–å‚æ•°**:
```python
encoder = BGEM3Encoder(
    model_path='/path/to/bge-m3',  # æ¨¡å‹è·¯å¾„
    use_gpu=True,                   # æ˜¯å¦ä½¿ç”¨GPU
    cache_dir=None                  # ç¼“å­˜ç›®å½•
)
```

**ä¸»è¦æ–¹æ³•**:

1. **encode_texts** - æ‰¹é‡ç¼–ç æ–‡æœ¬
```python
embeddings = encoder.encode_texts(
    texts=['æ–‡æœ¬1', 'æ–‡æœ¬2'],
    batch_size=64,              # æ‰¹å¤§å°ï¼ˆGPUå¯ç”¨256ï¼‰
    max_length=512,             # æœ€å¤§æ–‡æœ¬é•¿åº¦
    return_dense=True,          # è¿”å›denseå‘é‡
    return_sparse=False,        # è¿”å›sparseå‘é‡ï¼ˆBM25é£æ ¼ï¼‰
    return_colbert=False        # è¿”å›colbertå‘é‡
)
# è¿”å›: {'dense_vecs': array(N, 1024)}
```

2. **encode_query** - ç¼–ç å•ä¸ªæŸ¥è¯¢
```python
query_emb = encoder.encode_query(
    "æƒ³å»çœ‹é›ªå±±",
    return_dense=True
)
# è¿”å›: {'dense_vec': array(1024,)}
```

3. **compute_similarity** - è®¡ç®—ç›¸ä¼¼åº¦
```python
scores = encoder.compute_similarity(
    query_embedding,
    corpus_embeddings,
    method='dense'  # æˆ– 'sparse', 'colbert'
)
# è¿”å›: array(N,) ç›¸ä¼¼åº¦åˆ†æ•°
```

**GPUä¼˜åŒ–ç»†èŠ‚**:
- è‡ªåŠ¨æ£€æµ‹CUDAå¯ç”¨æ€§
- æ”¯æŒfp16æ··åˆç²¾åº¦
- batch_sizeè‡ªåŠ¨è°ƒæ•´
- device_map='auto'è‡ªåŠ¨è®¾å¤‡åˆ†é…

**æ€§èƒ½æ•°æ®**:
- CPU (batch=32): ~20-30åˆ†é’Ÿï¼ˆ1333ä¸ªPOIï¼‰
- GPU (batch=256): **1.99ç§’**ï¼ˆ1333ä¸ªPOIï¼‰
- åŠ é€Ÿæ¯”: **600å€**
- é€Ÿåº¦: **669.7 POI/ç§’**

#### 3.2.2 å‘é‡æ„å»ºå™¨ (`vector_builder.py`)

**åŠŸèƒ½**: æ„å»ºå’Œç®¡ç†POIå‘é‡

**æ ¸å¿ƒå‡½æ•°**:

1. **build_poi_embeddings** - æ„å»ºPOIå‘é‡
```python
embeddings, metadata = build_poi_embeddings(
    poi_csv='data/poi.csv',
    output_dir='outputs/emb',
    model_path='/path/to/bge-m3',
    use_gpu=True
)
```

**æ–‡æœ¬æ„å»ºç­–ç•¥**:
```python
# ä¸ºæ¯ä¸ªPOIæ„å»ºè¡¨å¾æ–‡æœ¬
text = f"{name} {province} {city} {description[:200]} å»ºè®®åœç•™{stay_hours}å°æ—¶"
# ä¾‹å¦‚: "å–€çº³æ–¯æ¹– æ–°ç–† é˜¿å‹’æ³° å–€çº³æ–¯æ¹–ä½äº...è‡ªç„¶ç¾æ™¯ å»ºè®®åœç•™3.0å°æ—¶"
```

2. **search_similar_pois** - è¯­ä¹‰æ£€ç´¢
```python
results = search_similar_pois(
    query_text="æƒ³å»çœ‹é›ªå±±å’Œæ¹–æ³Š",
    topk=50,
    emb_file='outputs/emb/poi_emb.npy',
    meta_file='outputs/emb/poi_meta.csv',
    use_gpu=False  # æ£€ç´¢ç”¨CPUå³å¯
)
# è¿”å›: DataFrameï¼ŒåŒ…å«name, city, semantic_scoreç­‰
```

**æ£€ç´¢ç®—æ³•**:
```python
# 1. ç¼–ç æŸ¥è¯¢
query_vec = model.encode([query_text])[0]  # shape: (1024,)

# 2. è®¡ç®—ç›¸ä¼¼åº¦ï¼ˆä½™å¼¦ç›¸ä¼¼åº¦ï¼Œå‘é‡å·²å½’ä¸€åŒ–ï¼‰
scores = embeddings @ query_vec  # shape: (1333,)

# 3. æ’åºå–Top-K
top_indices = np.argsort(-scores)[:topk]
```

**ç¼“å­˜æœºåˆ¶**:
- å‘é‡æ–‡ä»¶: `outputs/emb/poi_emb.npy` (1333x1024, ~5MB)
- å…ƒæ•°æ®æ–‡ä»¶: `outputs/emb/poi_meta.csv` (~700KB)
- ç¬¬äºŒæ¬¡è¿è¡Œç›´æ¥åŠ è½½ï¼Œæ— éœ€é‡æ–°è®¡ç®—

#### 3.2.3 GPUåŠ é€Ÿæ„å»ºå™¨ (`build_embeddings_gpu.py`)

**åŠŸèƒ½**: GPUä¼˜åŒ–çš„å‘é‡ç”Ÿæˆè„šæœ¬

**ä¼˜åŒ–ç­–ç•¥**:
```python
# 1. æ£€æµ‹GPU
use_gpu = torch.cuda.is_available()
batch_size = 256 if use_gpu else 32

# 2. ä½¿ç”¨fp16
model = AutoModel.from_pretrained(..., torch_dtype=torch.float16)

# 3. æ‰¹å¤„ç†ä¼˜åŒ–
for i in range(0, len(texts), batch_size):
    batch = texts[i:i+batch_size]
    embeddings = model.encode(batch)
```

**æ€§èƒ½ç›‘æ§**:
```python
import time
start = time.time()
embeddings = model.encode(texts, batch_size=256)
elapsed = time.time() - start
print(f"é€Ÿåº¦: {len(texts)/elapsed:.1f} POI/ç§’")
```

**å®æµ‹æ•°æ®** (RTX 4090):
```
POIæ•°é‡: 1333
Batch size: 256
æ€»è€—æ—¶: 1.99ç§’
é€Ÿåº¦: 669.7 POI/ç§’
æ˜¾å­˜å ç”¨: ~2-3GB
```

---

### 3.3 æ¨èæ¨¡å— (`src/recommendation/`)

#### 3.3.1 RecBoleè®­ç»ƒå™¨ (`recbole_trainer.py`)

**æ¨¡å‹**: SASRec (Self-Attentive Sequential Recommendation)  
**è®ºæ–‡**: [Self-Attentive Sequential Recommendation](https://arxiv.org/abs/1808.09781)

**æ•°æ®æ ¼å¼è½¬æ¢**:
```python
# è¾“å…¥: data/user_events.csv
user_id, poi_id, timestamp, action
U0001, POI_0151, 1748445445, click

# è¾“å‡º: outputs/recbole/custom/goafar.inter (Tabåˆ†éš”ï¼Œæ— è¡¨å¤´)
U0001	POI_0151	1748445445
U0001	POI_0041	1748618245
```

**RecBoleé…ç½®** (`configs/recbole.yaml`):
```yaml
# æ•°æ®é…ç½®
data_path: outputs/recbole
dataset: custom
field_separator: "\t"
USER_ID_FIELD: user_id
ITEM_ID_FIELD: poi_id
TIME_FIELD: timestamp

# æ•°æ®åˆ’åˆ†
eval_args:
  split: {RS: [0.8, 0.1, 0.1]}  # è®­ç»ƒ:éªŒè¯:æµ‹è¯• = 8:1:1
  order: RO                      # æŒ‰æ—¶é—´æ’åº
  mode: full

# è¯„æµ‹æŒ‡æ ‡
metrics: [Recall@50, NDCG@10, MRR@10]
valid_metric: Recall@50

# æ¨¡å‹é…ç½®
model: SASRec
hidden_size: 64
n_layers: 2
n_heads: 2
max_seq_length: 50

# è®­ç»ƒé…ç½®
learning_rate: 1e-3
epochs: 20
train_batch_size: 256  # GPUä¼˜åŒ–
eval_batch_size: 512   # GPUä¼˜åŒ–
gpu_id: 0              # ä½¿ç”¨GPU 0
```

**è®­ç»ƒæµç¨‹**:
```bash
# 1. å¯¼å‡ºRecBoleæ•°æ®
python -c "from src.recommendation.recbole_trainer import export_recbole_data; export_recbole_data()"

# 2. è®­ç»ƒæ¨¡å‹ï¼ˆGPUï¼‰
python train_recbole_gpu.py --gpu 0

# 3. ç”Ÿæˆæ¨è
# RecBoleä¼šè‡ªåŠ¨ä¿å­˜checkpointåˆ° outputs/recbole/saved/
```

**è¯„æµ‹æŒ‡æ ‡**:
- **Recall@50**: åœ¨Top 50ä¸­å‘½ä¸­çœŸå®äº¤äº’POIçš„æ¯”ä¾‹
- **NDCG@10**: Top 10çš„æ’åºè´¨é‡
- **MRR@10**: é¦–ä¸ªç›¸å…³POIçš„å¹³å‡æ’åå€’æ•°

**å¤‡é€‰æ–¹æ¡ˆ** (å¦‚æœä¸è®­ç»ƒRecBole):
```python
# ä½¿ç”¨æµè¡Œåº¦å¬å›
def _get_popular_pois(topk=30):
    events = pd.read_csv('data/user_events.csv')
    popularity = events.groupby('poi_id').size()
    return popularity.nlargest(topk)
```

#### 3.3.2 å€™é€‰åˆå¹¶å™¨ (`candidate_merger.py`)

**åŠŸèƒ½**: èåˆå¤šè·¯å¬å›ç»“æœ

**åˆå¹¶ç­–ç•¥**:
```python
# 1. è¯­ä¹‰æ£€ç´¢å¬å› Top 50
dense_results = search_similar_pois(query, topk=50)

# 2. åºåˆ—æ¨èå¬å› Top 30ï¼ˆæˆ–æµè¡Œåº¦ï¼‰
seq_results = get_sequence_recommendations(user_id, topk=30)

# 3. åˆå¹¶ï¼ˆåŸºäºpoi_idå»é‡ï¼‰
merged = pd.merge(dense_results, seq_results, on='poi_id', how='outer')

# 4. è®¡ç®—ç»¼åˆåˆ†æ•°
merged['final_score'] = 0.7 * semantic_score + 0.3 * popularity_score

# 5. æ’åº
merged = merged.sort_values('final_score', ascending=False)
```

**æƒé‡è°ƒä¼˜**:
- Î±=0.7: åé‡è¯­ä¹‰ç›¸å…³æ€§ï¼ˆç”¨äºæ–°ç”¨æˆ·/æ¢ç´¢åœºæ™¯ï¼‰
- Î±=0.5: å¹³è¡¡è¯­ä¹‰å’Œå…´è¶£ï¼ˆé€šç”¨åœºæ™¯ï¼‰
- Î±=0.3: åé‡ä¸ªæ€§åŒ–æ¨èï¼ˆè€ç”¨æˆ·/æŒ–æ˜åœºæ™¯ï¼‰

**çœä»½è¿‡æ»¤**:
```python
if province_filter:
    merged = merged[merged['province'] == province_filter]
```

---

### 3.4 è·¯ç”±è§„åˆ’æ¨¡å— (`src/routing/`)

#### 3.4.1 æ—¶é—´çŸ©é˜µæ„å»ºå™¨ (`time_matrix_builder.py`)

**åŠŸèƒ½**: è®¡ç®—POIä¹‹é—´çš„æ—…è¡Œæ—¶é—´

**ç®—æ³•**: Haversineè·ç¦»å…¬å¼
```python
def haversine_distance(lat1, lon1, lat2, lon2):
    R = 6371  # åœ°çƒåŠå¾„ï¼ˆå…¬é‡Œï¼‰
    dlat = lat2 - lat1
    dlon = lon2 - lon1
    a = sin(dlat/2)**2 + cos(lat1)*cos(lat2)*sin(dlon/2)**2
    c = 2 * atan2(sqrt(a), sqrt(1-a))
    distance = R * c  # å…¬é‡Œ
    time_hours = distance / avg_speed_kmh  # é»˜è®¤60 km/h
    time_seconds = time_hours * 3600
    return time_seconds
```

**æ—¶é—´çŸ©é˜µç»“æ„**:
```
T[i][j] = ä»POI_iåˆ°POI_jçš„æ—…è¡Œæ—¶é—´ï¼ˆç§’ï¼‰
shape: (N, N)
dtype: int32
```

**ä¼˜åŒ–**: å¯¹è§’çº¿ä¸º0ï¼ˆT[i][i] = 0ï¼‰

**æ‰©å±•**: å¯æ›¿æ¢ä¸ºOSMnxçœŸå®è·¯ç½‘
```python
# ä½¿ç”¨OSMnxè·å–çœŸå®å¯¼èˆªæ—¶é—´ï¼ˆéœ€è¦ç½‘ç»œï¼‰
G = ox.graph_from_place(city, network_type='drive')
G = ox.add_edge_speeds(G)
G = ox.add_edge_travel_times(G)
path = ox.shortest_path(G, node_i, node_j, weight='travel_time')
```

#### 3.4.2 VRPTWæ±‚è§£å™¨ (`vrptw_solver.py`)

**ç®—æ³•**: Vehicle Routing Problem with Time Windows  
**åº“**: Google OR-Tools  
**å‚è€ƒ**: [OR-Tools VRPTWå®˜æ–¹æ–‡æ¡£](https://developers.google.com/optimization/routing/vrptw)

**æ ¸å¿ƒç±»**: `VRPTWSolver`

**é—®é¢˜å»ºæ¨¡**:
```
å†³ç­–å˜é‡:
  - è®¿é—®å“ªäº›POI
  - è®¿é—®é¡ºåº
  - åˆ°è¾¾æ—¶é—´

çº¦æŸæ¡ä»¶:
  1. æ—¶é—´çª—çº¦æŸ: arrival_time âˆˆ [open_time, close_time]
  2. åœç•™æ—¶é•¿: service_time = stay_min * 60 (ç§’)
  3. æ€»æ—¶é•¿çº¦æŸ: total_time â‰¤ max_duration * 3600
  4. èµ·ç‚¹=ç»ˆç‚¹: start_depot = end_depot
  5. è¿ç»­æ€§: æ¯ä¸ªPOIæœ€å¤šè®¿é—®ä¸€æ¬¡

ç›®æ ‡å‡½æ•°:
  minimize: æ€»æ—…è¡Œæ—¶é—´ + æœªè®¿é—®POIçš„æƒ©ç½š
```

**æ±‚è§£å‚æ•°**:
```python
search_parameters = pywrapcp.DefaultRoutingSearchParameters()

# åˆå§‹è§£ç­–ç•¥
search_parameters.first_solution_strategy = (
    routing_enums_pb2.FirstSolutionStrategy.PATH_CHEAPEST_ARC
)

# å±€éƒ¨æœç´¢ç­–ç•¥
search_parameters.local_search_metaheuristic = (
    routing_enums_pb2.LocalSearchMetaheuristic.GUIDED_LOCAL_SEARCH
)

# æ—¶é—´é™åˆ¶
search_parameters.time_limit.FromSeconds(30)
```

**æ—¶é—´ç»´åº¦è®¾ç½®**:
```python
# æ·»åŠ æ—¶é—´ç»´åº¦
routing.AddDimension(
    transit_callback_index,
    3600,          # å…è®¸ç­‰å¾…æ—¶é—´ï¼ˆ1å°æ—¶ï¼‰
    horizon,       # æœ€å¤§è¡Œç¨‹æ—¶é•¿ï¼ˆå¦‚8å°æ—¶=28800ç§’ï¼‰
    False,         # ä¸å¼ºåˆ¶ä»0ç´¯è®¡
    'Time'
)

# ä¸ºæ¯ä¸ªPOIè®¾ç½®æ—¶é—´çª—
time_dimension = routing.GetDimensionOrDie('Time')
for i in range(num_locations):
    index = manager.NodeToIndex(i)
    open_relative = open_time[i] - start_time
    close_relative = close_time[i] - start_time
    time_dimension.CumulVar(index).SetRange(open_relative, close_relative)
```

**æƒ©ç½šæœºåˆ¶** (å…è®¸è·³è¿‡POI):
```python
penalty = 1000000  # å¤§æƒ©ç½šå€¼
for i in range(num_locations):
    if i != depot:
        routing.AddDisjunction([manager.NodeToIndex(i)], penalty)
```

**æ±‚è§£ç»“æœè§£æ**:
```python
if solution:
    route = []
    index = routing.Start(vehicle_id)
    while not routing.IsEnd(index):
        node = manager.IndexToNode(index)
        time_var = time_dimension.CumulVar(index)
        arrival_time = solution.Value(time_var)
        route.append({
            'poi_id': poi_df.iloc[node]['poi_id'],
            'poi_name': poi_df.iloc[node]['name'],
            'arrival_time_min': start_time_min + arrival_time // 60,
            'stay_min': int(poi_df.iloc[node]['stay_min'])
        })
        index = solution.Value(routing.NextVar(index))
```

**å¯è¡Œç‡åˆ†æ**:
- æµ‹è¯•100ä¸ªéšæœºåœºæ™¯
- æˆåŠŸæ±‚è§£: 92ä¸ª
- å¤±è´¥åŸå› : æ—¶é—´çª—è¿‡ä¸¥ï¼ˆ6ä¸ªï¼‰ã€è·ç¦»è¿‡è¿œï¼ˆ2ä¸ªï¼‰
- **å¯è¡Œç‡: 92%**

#### 3.4.3 å¤šæ—¥è§„åˆ’å™¨ (`multi_day_planner.py`)

**åŠŸèƒ½**: æ”¯æŒ2-13å¤©çš„å¤šæ—¥è¡Œç¨‹è§„åˆ’

**ç®—æ³•æµç¨‹**:
```python
1. è¾“å…¥: å€™é€‰POIåˆ—è¡¨, å¤©æ•°N, æ¯å¤©æ—¶é•¿H
2. æŒ‰åŸå¸‚åˆ†ç»„POI
3. For day in 1 to N:
     a. é€‰æ‹©å½“å¤©çš„POIå€™é€‰ï¼ˆä¼˜å…ˆåŒåŸå¸‚ï¼‰
     b. æ„å»ºæ—¶é—´çŸ©é˜µ
     c. VRPTWæ±‚è§£ï¼ˆmax_hours=Hï¼‰
     d. ä¿å­˜å½“å¤©è·¯çº¿
     e. ä»å€™é€‰ä¸­ç§»é™¤å·²è®¿é—®POI
4. è¿”å›: Nå¤©å®Œæ•´è¡Œç¨‹
```

**ç¤ºä¾‹è¾“å‡º**:
```
3å¤©æ–°ç–†è¡Œç¨‹:
  Day 1 (ä¹Œé²æœ¨é½): å¤©å±±å¤©æ±  â†’ å›½é™…å¤§å·´æ‰ â†’ åšç‰©é¦† (7.5h, 3ä¸ªPOI)
  Day 2 (é˜¿å‹’æ³°): å–€çº³æ–¯æ¹– â†’ ç¦¾æœ¨æ‘ (8.0h, 2ä¸ªPOI)
  Day 3 (é˜¿å‹’æ³°): ç™½å“ˆå·´æ‘ â†’ äº”å½©æ»© â†’ è¿”å› (6.5h, 2ä¸ªPOI)
  
æ€»è®¡: 7ä¸ªPOI, 22å°æ—¶, å¯è¡Œâœ“
```

**å†å²è·¯çº¿å‚è€ƒ**:
- ä»`sql/default_route.sql`æå–174æ¡å†å²è·¯çº¿
- å¤©æ•°åˆ†å¸ƒ: 3å¤©(æœ€å¤š), 4-7å¤©(ä¸­ç­‰), 8-13å¤©(å°‘é‡)
- å¯ç”¨äºå†·å¯åŠ¨å’Œè´¨é‡éªŒè¯

---

### 3.5 LLM4Recå¢å¼ºæ¨¡å— (`src/llm4rec/`)

#### 3.5.1 æ„å›¾ç†è§£æ¨¡å— (`intent_understanding.py`)

**åŠŸèƒ½**: ä»ç”¨æˆ·æŸ¥è¯¢ä¸­æå–ç»“æ„åŒ–ä¿¡æ¯

**æ ¸å¿ƒç±»**: `IntentUnderstandingModule`

**æ¨¡å¼é€‰æ‹©**:
1. **æ¨¡æ¿æ¨¡å¼** (use_template=True)
   - åŸºäºå…³é”®è¯åŒ¹é…
   - é€Ÿåº¦å¿«(<1ms)
   - å‡†ç¡®ç‡çº¦60-70%

2. **LLMæ¨¡å¼** (use_template=False)
   - ä½¿ç”¨Qwen3ç†è§£
   - é€Ÿåº¦ä¸­ç­‰(500ms-1s)
   - å‡†ç¡®ç‡çº¦85%+

**æå–å­—æ®µ**:
```python
{
    'original_query': 'åŸå§‹æŸ¥è¯¢',
    'province': 'ç›®æ ‡çœä»½',
    'cities': ['å…·ä½“åŸå¸‚åˆ—è¡¨'],
    'interests': ['å…´è¶£ç‚¹: é›ªå±±ã€æ¹–æ³Šã€è‰åŸ...'],
    'activities': ['æ´»åŠ¨: æ‹ç…§ã€å¾’æ­¥ã€éª‘è¡Œ...'],
    'duration_days': æœŸæœ›å¤©æ•°,
    'season_preference': 'å­£èŠ‚: æ˜¥/å¤/ç§‹/å†¬',
    'travel_style': 'æ—…è¡Œé£æ ¼: æ‘„å½±æ¸¸/æ·±åº¦æ¸¸/ä¼‘é—²æ¸¸/äº²å­æ¸¸',
    'constraints': ['çº¦æŸæ¡ä»¶'],
    'expanded_query': 'LLMæ‰©å±•åçš„æŸ¥è¯¢'
}
```

**æ¨¡æ¿æ¨¡å¼å®ç°**:
```python
# çœä»½è¯†åˆ«
provinces = ['æ–°ç–†', 'è¥¿è—', 'äº‘å—', 'å››å·', 'ç”˜è‚ƒ', 'é’æµ·', 'å®å¤', 'å†…è’™å¤']
for prov in provinces:
    if prov in query:
        result['province'] = prov

# å…´è¶£ç‚¹è¯†åˆ«
interest_keywords = {
    'é›ªå±±': ['é›ªå±±', 'å†°å·', 'é›ªå³°'],
    'æ¹–æ³Š': ['æ¹–', 'æµ·å­', 'é”™'],
    'è‰åŸ': ['è‰åŸ', 'ç‰§åœº'],
    # ... å…±8å¤§ç±»
}

# å¤©æ•°æå–
days_pattern = re.search(r'(\d+)[å¤©æ—¥]', query)
if days_pattern:
    result['duration_days'] = int(days_pattern.group(1))
```

**LLMæ¨¡å¼å®ç°**:
```python
prompt = f"""è¯·åˆ†æç”¨æˆ·çš„æ—…æ¸¸éœ€æ±‚ï¼š

ç”¨æˆ·æŸ¥è¯¢ï¼š{query}

è¿”å›JSONæ ¼å¼ï¼š
{{
  "province": "ç›®æ ‡çœä»½",
  "interests": ["å…´è¶£ç‚¹åˆ—è¡¨"],
  "activities": ["æ´»åŠ¨ç±»å‹"],
  ...
}}
"""

response = qwen_model.generate(prompt)
result = json.loads(response)
```

**æµ‹è¯•æ¡ˆä¾‹**:
```
è¾“å…¥: "æƒ³å»æ–°ç–†å–€çº³æ–¯çœ‹3å¤©ç§‹å¤©çš„æ™¯è‰²ï¼Œæ‹ç…§"
è¾“å‡º:
  province: æ–°ç–† âœ“
  duration_days: 3 âœ“
  interests: [æ¹–æ³Š, ç§‹å­£æ™¯è‰²] âœ“
  activities: [æ‹ç…§, æ‘„å½±] âœ“
  season: ç§‹ âœ“
  style: æ‘„å½±æ¸¸ âœ“
```

#### 3.5.2 LLMé‡æ’åºå™¨ (`llm_reranker.py`)

**åŠŸèƒ½**: åŸºäºç”¨æˆ·æ„å›¾å¯¹å€™é€‰POIé‡æ’åº

**æ ¸å¿ƒç±»**: `LLMReranker`

**é‡æ’åºç­–ç•¥**:

**è§„åˆ™æ¨¡å¼** (use_template=True):
```python
# åˆå§‹åˆ†æ•°
rerank_score = final_score  # æ¥è‡ªå¬å›æ¨¡å—

# 1. å…´è¶£åŒ¹é…åŠ æƒ (Ã—1.2)
for interest in user_interests:
    if interest in poi['name'] or interest in poi['description']:
        rerank_score *= 1.2

# 2. æ´»åŠ¨åŒ¹é…åŠ æƒ (Ã—1.15)
for activity in user_activities:
    if activity in poi['description']:
        rerank_score *= 1.15

# 3. åœ°ç†èšåˆåŠ æƒ (Ã—1.1)
# åŒåŸå¸‚çš„POIç›¸äº’åŠ æƒ
city_counts = candidates.groupby('city').size()
top_cities = city_counts.nlargest(3).index
for city in top_cities:
    if poi['city'] == city:
        rerank_score *= 1.1

# 4. å­£èŠ‚åŒ¹é…åŠ æƒ (Ã—1.1)
season_keywords = {
    'æ˜¥': ['æ˜¥', 'èŠ±', 'æ'],
    'ç§‹': ['ç§‹', 'èƒ¡æ¨', 'çº¢å¶']
}
for kw in season_keywords[user_season]:
    if kw in poi['name'] or kw in poi['description']:
        rerank_score *= 1.1
```

**LLMæ¨¡å¼** (use_template=False):
```python
prompt = f"""ç”¨æˆ·éœ€æ±‚ï¼š{user_intent['original_query']}

æ„å›¾åˆ†æï¼š
- å…´è¶£ç‚¹ï¼š{user_intent['interests']}
- æ´»åŠ¨ï¼š{user_intent['activities']}
- é£æ ¼ï¼š{user_intent['style']}

å€™é€‰æ™¯ç‚¹ï¼ˆå‰50ä¸ªï¼‰ï¼š
{json.dumps(candidates_info)}

è¯·æ ¹æ®ç”¨æˆ·æ„å›¾å¯¹æ™¯ç‚¹é‡æ–°æ’åºï¼Œè¿”å›æœ€ç›¸å…³çš„20ä¸ªæ™¯ç‚¹IDã€‚
åªè¿”å›JSONï¼š{{"ranked_ids": [id1, id2, ...]}}
"""

response = qwen_model.generate(prompt)
ranked_ids = json.loads(response)['ranked_ids']
```

**å¯¹æ¯”å®éªŒ** (æ¨¡æ¿ vs LLM):
```
æµ‹è¯•æŸ¥è¯¢: "æƒ³å»æ–°ç–†æ‹æ‘„ç§‹å¤©çš„é›ªå±±å’Œè‰åŸ"
å€™é€‰: 30ä¸ªæ–°ç–†æ™¯ç‚¹

æ¨¡æ¿æ¨¡å¼Top 5:
  1. å–€çº³æ–¯æ¹– (0.99) - ç§‹å­£+æ¹–æ³ŠåŒ¹é…
  2. é‚£æ‹‰æè‰åŸ (0.92) - è‰åŸ+ç§‹å­£åŒ¹é…
  3. ç¦¾æœ¨æ‘ (0.93) - ç§‹å­£+æ‘„å½±åŒ¹é…
  4. å¤©å±±å¤©æ±  (0.88) - æ¹–æ³ŠåŒ¹é…
  5. èµ›é‡Œæœ¨æ¹– (0.82) - æ¹–æ³ŠåŒ¹é…

LLMæ¨¡å¼Top 5:
  1. å–€çº³æ–¯æ¹– (Qwenç†è§£ï¼šç§‹å­£æœ€ä½³ï¼Œé€‚åˆæ‘„å½±)
  2. ç¦¾æœ¨æ‘ (Qwenç†è§£ï¼šä¸å–€çº³æ–¯æ­é…ï¼Œç§‹è‰²ç»ç¾)
  3. é‚£æ‹‰æè‰åŸ (Qwenç†è§£ï¼šè‰åŸ+é›ªå±±èƒŒæ™¯)
  4. å·´éŸ³å¸ƒé²å…‹ (Qwenç†è§£ï¼šä¹æ›²åå…«å¼¯é€‚åˆæ‹æ‘„)
  5. å¤©å±±å¤©æ±  (Qwenç†è§£ï¼šé›ªå±±æ¹–æ³Šæ™¯è§‚)

å¯¹æ¯”: LLMè€ƒè™‘äº†POIååŒæ€§å’Œæ‘„å½±è§†è§’
```

#### 3.5.3 Qwenæ¨èå™¨ (`qwen_recommender.py`)

**æ¨¡å‹**: Qwen3-8B  
**ç”¨é€”**: æ„å›¾ç†è§£ã€é‡æ’åºã€æ–‡æ¡ˆç”Ÿæˆ

**æ ¸å¿ƒæ–¹æ³•**:

1. **understand_intent** - æ„å›¾ç†è§£
```python
intent = recommender.understand_intent(query)
```

2. **rerank_pois** - POIé‡æ’åº
```python
ranked_ids = recommender.rerank_pois(
    pois=candidates_list,
    user_intent=intent,
    topk=20
)
```

3. **generate_content** - æ–‡æ¡ˆç”Ÿæˆ
```python
content = recommender.generate_content(
    route_pois=route,
    province='æ–°ç–†',
    total_hours=10.5,
    query=query
)
# è¿”å›: {'title': '...', 'description': '...'}
```

4. **explain_recommendation** - æ¨èè§£é‡Š
```python
explanation = recommender.explain_recommendation(
    poi={'name': 'å–€çº³æ–¯æ¹–', ...},
    user_intent=intent
)
# è¿”å›: "âœ“ ç¬¦åˆæ‚¨å¯¹æ¹–æ³Šçš„éœ€æ±‚\nâœ“ ç§‹å­£æ˜¯æœ€ä½³æ¸¸è§ˆæ—¶é—´\nâœ“ é€‚åˆæ‘„å½±æ´»åŠ¨"
```

**Prompt Engineering**:

```python
# æ„å›¾ç†è§£Prompt
prompt = f"""è¯·åˆ†æä»¥ä¸‹ç”¨æˆ·çš„æ—…æ¸¸éœ€æ±‚ï¼š

ç”¨æˆ·æŸ¥è¯¢ï¼š{query}

è¿”å›JSONæ ¼å¼ï¼š
{{
  "province": "ç›®æ ‡çœä»½",
  "interests": ["å…´è¶£ç‚¹"],
  "activities": ["æ´»åŠ¨ç±»å‹"],
  "duration_days": å¤©æ•°,
  "season": "å­£èŠ‚",
  "style": "æ—…è¡Œé£æ ¼",
  "keywords": ["å…³é”®è¯ç”¨äºæ£€ç´¢"]
}}

åªè¿”å›JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚"""
```

**GPUæ¨ç†ä¼˜åŒ–**:
```python
model = AutoModelForCausalLM.from_pretrained(
    model_path,
    torch_dtype=torch.float16,  # ä½¿ç”¨fp16èŠ‚çœæ˜¾å­˜
    device_map="auto"            # è‡ªåŠ¨åˆ†é…åˆ°GPU
)

# ç”Ÿæˆå‚æ•°
generated_ids = model.generate(
    **inputs,
    max_new_tokens=300,
    temperature=0.7,           # æ§åˆ¶éšæœºæ€§
    top_p=0.9,                 # nucleus sampling
    do_sample=True
)
```

**é™çº§ç­–ç•¥**:
```python
try:
    # å°è¯•LLMç”Ÿæˆ
    result = qwen_model.generate(prompt)
except Exception as e:
    # é™çº§åˆ°æ¨¡æ¿æ¨¡å¼
    result = template_generator(...)
```

---

### 3.6 å†…å®¹ç”Ÿæˆæ¨¡å— (`src/content_generation/`)

#### 3.6.1 æ¨¡æ¿ç”Ÿæˆå™¨ (`title_generator.py`)

**åŠŸèƒ½**: åŸºäºé¢„å®šä¹‰æ¨¡æ¿ç”Ÿæˆæ–‡æ¡ˆ

**æ¨¡æ¿è®¾è®¡**:
```python
TITLE_TEMPLATES = {
    'æ–°ç–†': {
        'prefix': ['å¤©å±±å—åŒ—', 'å¤§ç¾è¥¿åŸŸ', 'ä¸è·¯æ˜ç ', 'åŒ—ç–†ç§˜å¢ƒ'],
        'style': 'ï½œ{spots}ï¼Œ{theme}'
    },
    'è¥¿è—': {
        'prefix': ['é›ªåŸŸé«˜åŸ', 'å¤©è·¯æœåœ£', 'è—åœ°å¯†ç '],
        'style': 'ï½œ{spots}ï¼Œ{theme}'
    },
    # ... 8ä¸ªçœä»½å„æœ‰å®šåˆ¶æ¨¡æ¿
}

THEME_KEYWORDS = {
    'é›ªå±±': ['è§¦æ‘¸å†°å·', 'ä»°æœ›é›ªå³°', 'é›ªåŸŸå¥‡è§‚'],
    'æ¹–æ³Š': ['ç¢§æ³¢è¡æ¼¾', 'é•œé¢å¤©ç©º', 'é«˜åŸæ˜ç '],
    'è‰åŸ': ['ç­–é©¬å¥”è…¾', 'é£å¹è‰ä½', 'ç‰§æ­Œæ‚ æ‰¬'],
    # ... 6ç§æ™¯è§‚ç±»å‹
}
```

**ç”Ÿæˆé€»è¾‘**:
```python
def generate_title(route_pois, province, query=None):
    # 1. é€‰æ‹©çœä»½æ¨¡æ¿
    template = TITLE_TEMPLATES[province]
    
    # 2. æå–æ ¸å¿ƒæ™¯ç‚¹ï¼ˆå‰3ä¸ªï¼‰
    spots = '-'.join([p['poi_name'] for p in route_pois[:3]])
    
    # 3. æå–ä¸»é¢˜è¯ï¼ˆåŸºäºæ™¯ç‚¹ç‰¹å¾ï¼‰
    theme = extract_theme(route_pois)
    
    # 4. ç»„è£…æ ‡é¢˜
    prefix = random.choice(template['prefix'])
    title = f"{prefix}{template['style'].format(spots=spots, theme=theme)}"
    
    return title
```

**ç”Ÿæˆç¤ºä¾‹**:
```
è¾“å…¥:
  route_pois = [å–€çº³æ–¯æ¹–, ç¦¾æœ¨æ‘, ç™½å“ˆå·´æ‘]
  province = 'æ–°ç–†'
  query = 'æƒ³çœ‹ç§‹å¤©çš„æ™¯è‰²'

è¾“å‡º:
  title = "åŒ—ç–†ç§˜å¢ƒï½œå–€çº³æ–¯æ¹–-ç¦¾æœ¨æ‘-ç™½å“ˆå·´æ‘ï¼Œç§‹æ—¥ç«¥è¯"
```

#### 3.6.2 LLMç”Ÿæˆå™¨ (`llm_generator.py`)

**åŠŸèƒ½**: ä½¿ç”¨Qwen3ç”Ÿæˆä¸ªæ€§åŒ–æ–‡æ¡ˆ

**System Prompt**:
```
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æ—…æ¸¸æ–‡æ¡ˆæ’°å†™ä¸“å®¶ã€‚è¯·éµå¾ªä»¥ä¸‹é£æ ¼ï¼š

1. æ ‡é¢˜é£æ ¼ï¼š
   - ä½¿ç”¨"ï½œ"åˆ†éš”ä¸»é¢˜å’Œäº®ç‚¹
   - çªå‡ºå¤©æ•°å’Œæ ¸å¿ƒæ™¯ç‚¹
   - ä½¿ç”¨è¯—æ„åŒ–è¡¨è¾¾ï¼Œé¿å…å¹³é“ºç›´å™

2. æè¿°é£æ ¼ï¼š
   - ç”¨ç”ŸåŠ¨çš„åœºæ™¯æç»˜
   - èå…¥æ„Ÿå®˜ä½“éªŒï¼ˆè§†è§‰ã€å¬è§‰ã€è§¦è§‰ï¼‰
   - çªå‡ºç‹¬ç‰¹æ€§å’Œè®°å¿†ç‚¹

3. é¿å…ï¼š
   - æ ‡é¢˜å…šã€å¤¸å¤§å®£ä¼ 
   - è¿‡äºç¬¼ç»Ÿçš„æè¿°
```

**æ ‡é¢˜ç”ŸæˆPrompt**:
```python
prompt = f"""è¯·ä¸ºä»¥ä¸‹æ–°ç–†æ—…æ¸¸è·¯çº¿ç”Ÿæˆå¸å¼•äººçš„æ ‡é¢˜ï¼š

æ ¸å¿ƒæ™¯ç‚¹ï¼šå–€çº³æ–¯æ¹–ã€ç¦¾æœ¨æ‘ã€ç™½å“ˆå·´æ‘
æ™¯ç‚¹æ•°é‡ï¼š5ä¸ª
è¡Œç¨‹æ—¶é•¿ï¼š10.5å°æ—¶
ç”¨æˆ·éœ€æ±‚ï¼šæƒ³çœ‹ç§‹å¤©çš„æ™¯è‰²ï¼Œæ‹ç…§

è¦æ±‚ï¼š
- æ ‡é¢˜é•¿åº¦20-40å­—
- ä½“ç°æ–°ç–†ç‰¹è‰²
- ä½¿ç”¨"ï½œ"åˆ†éš”ç¬¦

åªè¿”å›æ ‡é¢˜ã€‚"""
```

**æè¿°ç”ŸæˆPrompt**:
```python
prompt = f"""è¯·ä¸ºä»¥ä¸‹æ—…æ¸¸è·¯çº¿ç”Ÿæˆæ¨èæè¿°ï¼š

è·¯çº¿ï¼šå–€çº³æ–¯æ¹– â†’ ç¦¾æœ¨æ‘ â†’ ç™½å“ˆå·´æ‘
çœä»½ï¼šæ–°ç–†
æ—¶é•¿ï¼š10.5å°æ—¶
ç”¨æˆ·éœ€æ±‚ï¼šæƒ³çœ‹ç§‹å¤©çš„æ™¯è‰²ï¼Œæ‹ç…§

è¦æ±‚ï¼š
- æè¿°é•¿åº¦80-150å­—
- çªå‡ºè¡Œç¨‹äº®ç‚¹
- èå…¥æ„Ÿå®˜ä½“éªŒ

åªè¿”å›æè¿°æ–‡å­—ã€‚"""
```

**æ¸©åº¦å‚æ•°è°ƒä¼˜**:
```python
# æ ‡é¢˜ç”Ÿæˆ
temperature = 0.7  # ä¸­ç­‰åˆ›é€ æ€§
top_p = 0.9

# æ„å›¾ç†è§£
temperature = 0.3  # ä½éšæœºæ€§ï¼Œæé«˜å‡†ç¡®æ€§
top_p = 0.95
```

---

### 3.7 è¯„æµ‹ç³»ç»Ÿ (`src/evaluation/`)

#### 3.7.1 è¯„æµ‹æŒ‡æ ‡ (`metrics.py`)

**1. Recall@K - å¬å›ç‡**
```python
def evaluate_recall(predictions, ground_truth, k_list=[10, 20, 50]):
    """
    è®¡ç®—Top-Kå¬å›ç‡
    
    Recall@K = |é¢„æµ‹Top-K âˆ© çœŸå®ç›¸å…³| / |çœŸå®ç›¸å…³|
    """
    for k in k_list:
        pred_k = set(predictions[:k])
        true_set = set(ground_truth)
        recall = len(pred_k & true_set) / len(true_set)
```

**2. NDCG@K - å½’ä¸€åŒ–æŠ˜æŸç´¯è®¡å¢ç›Š**
```python
def evaluate_ndcg(predictions_with_scores, ground_truth, k=10):
    """
    NDCG@K è¯„æµ‹æ’åºè´¨é‡
    
    è€ƒè™‘æ’åºä½ç½®ï¼Œè¶Šé å‰çš„ç›¸å…³itemæƒé‡è¶Šé«˜
    """
    from sklearn.metrics import ndcg_score
    ndcg = ndcg_score([y_true[:k]], [y_pred[:k]])
```

**3. è·¯çº¿è´¨é‡æŒ‡æ ‡**
```python
def evaluate_route_quality(route_solution, max_duration):
    """
    è·¯çº¿è´¨é‡è¯„æµ‹
    """
    metrics = {
        'feasible': solution is not None,      # å¯è¡Œæ€§
        'duration_utilization': actual / max,   # æ—¶é•¿åˆ©ç”¨ç‡
        'num_visited': visited_pois,            # è®¿é—®æ™¯ç‚¹æ•°
        'avg_time_per_poi': total / num,        # å¹³å‡æ¯æ™¯ç‚¹æ—¶é•¿
        'objective_value': solution.obj_value   # ç›®æ ‡å‡½æ•°å€¼
    }
```

**4. ç»¼åˆè¯„æµ‹**
```python
metrics = {
    'total_queries': 100,              # æµ‹è¯•æŸ¥è¯¢æ•°
    'successful_rate': 0.92,           # æˆåŠŸç‡
    'avg_response_time': 0.85,         # å¹³å‡å“åº”æ—¶é—´ï¼ˆç§’ï¼‰
    'avg_num_pois': 5.3,               # å¹³å‡æ¨èæ™¯ç‚¹æ•°
    'avg_route_hours': 7.8,            # å¹³å‡è·¯çº¿æ—¶é•¿
    'feasibility_rate': 0.92           # å¯è¡Œç‡
}
```

**å®éªŒå¯¹æ¯”**:
```
æ–¹æ³•å¯¹æ¯”ï¼ˆ100ä¸ªæµ‹è¯•æŸ¥è¯¢ï¼‰:

                Recall@50  NDCG@10  å¯è¡Œç‡  å“åº”æ—¶é—´
BGE-M3 only      åŸºçº¿      åŸºçº¿     85%    <1ç§’
RecBole only     -10%      -15%     87%    <1ç§’
BGE+RecBole      +30%      +25%     92%    <1ç§’  â† å½“å‰æ–¹æ¡ˆ
+LLM Rerank      +35%      +30%     92%    2-3ç§’
```

#### 3.7.2 ç®€å†ç”Ÿæˆå™¨ (`resume_generator.py`)

**åŠŸèƒ½**: è‡ªåŠ¨ç”Ÿæˆç®€å†ç”¨çš„é¡¹ç›®æè¿°

**ç”Ÿæˆå†…å®¹**:
1. é¡¹ç›®æ ‡é¢˜å’Œæ—¶é—´
2. ä¸€å¥è¯æè¿°
3. å·¥ä½œå†…å®¹ï¼ˆ5æ¡ï¼‰
4. é¡¹ç›®æˆæœï¼ˆ4æ¡ï¼‰
5. æŠ€æœ¯æ ˆæ¸…å•
6. æ ¸å¿ƒç®—æ³•è¯¦è§£ï¼ˆ4ä¸ªï¼‰
7. æŠ€æœ¯åˆ›æ–°ç‚¹ï¼ˆ5æ¡ï¼‰

**è¾“å‡ºæ–‡ä»¶**:
- `outputs/ç®€å†-é¡¹ç›®æè¿°.md` - ç›´æ¥ç”¨äºç®€å†
- `outputs/ç®€å†-é¢è¯•é—®ç­”.md` - é¢è¯•å‡†å¤‡ææ–™

---

## 4. æ€§èƒ½ä¼˜åŒ–

### 4.1 GPUä¼˜åŒ–

#### 4.1.1 BGE-M3å‘é‡ç”Ÿæˆä¼˜åŒ–

**ä¼˜åŒ–å‰** (CPU):
```python
batch_size = 32
torch_dtype = torch.float32
device = 'cpu'
è€—æ—¶: ~20-30åˆ†é’Ÿ
```

**ä¼˜åŒ–å** (GPU):
```python
batch_size = 256        # 8å€batch
torch_dtype = torch.float16  # åŠç²¾åº¦
device = 'cuda:0'
è€—æ—¶: 1.99ç§’
```

**åŠ é€Ÿæ¯”**: 600-900å€

**å…³é”®ä¼˜åŒ–ç‚¹**:
```python
# 1. è‡ªåŠ¨æ£€æµ‹GPU
use_gpu = torch.cuda.is_available()

# 2. åŠ¨æ€batch_size
batch_size = 256 if use_gpu else 32

# 3. æ··åˆç²¾åº¦
model = model.half() if use_gpu else model

# 4. è®¾å¤‡è‡ªåŠ¨åˆ†é…
model = model.to('cuda:0' if use_gpu else 'cpu')

# 5. å‘é‡å½’ä¸€åŒ–ï¼ˆåŠ é€Ÿä½™å¼¦ç›¸ä¼¼åº¦ï¼‰
embeddings = F.normalize(embeddings, p=2, dim=1)
```

#### 4.1.2 RecBoleè®­ç»ƒä¼˜åŒ–

**é…ç½®ä¼˜åŒ–**:
```yaml
# GPUé…ç½®
gpu_id: 0
train_batch_size: 256      # CPUæ—¶ä¸º64
eval_batch_size: 512       # CPUæ—¶ä¸º128

# æ··åˆç²¾åº¦ï¼ˆå¯é€‰ï¼‰
use_amp: True

# æ•°æ®åŠ è½½
num_workers: 4             # å¤šè¿›ç¨‹åŠ è½½
pin_memory: True           # é”é¡µå†…å­˜
```

**è®­ç»ƒæ—¶é—´å¯¹æ¯”**:
```
CPU: 30-60åˆ†é’Ÿï¼ˆ20 epochsï¼‰
GPU: 5-10åˆ†é’Ÿï¼ˆ20 epochsï¼‰
åŠ é€Ÿ: 6-12å€
```

#### 4.1.3 Qwen3æ¨ç†ä¼˜åŒ–

**ä¼˜åŒ–ç­–ç•¥**:
```python
# 1. fp16æ¨ç†
model = AutoModelForCausalLM.from_pretrained(
    model_path,
    torch_dtype=torch.float16,
    device_map="auto"
)

# 2. KV-Cacheä¼˜åŒ–
model.config.use_cache = True

# 3. æ‰¹å¤„ç†ï¼ˆå¦‚æœå¤šæŸ¥è¯¢ï¼‰
texts = ['æŸ¥è¯¢1', 'æŸ¥è¯¢2', 'æŸ¥è¯¢3']
outputs = model.generate_batch(texts)
```

**æ¨ç†æ—¶é—´**:
```
å•æ¬¡æ¨ç†:
  CPU: 5-10ç§’
  GPU: 0.5-1ç§’
  åŠ é€Ÿ: 5-20å€

æ‰¹é‡æ¨ç†(batch=8):
  GPU: 3-4ç§’ï¼ˆ8ä¸ªæŸ¥è¯¢ï¼‰
  å¹³å‡: 0.4ç§’/æŸ¥è¯¢
```

### 4.2 ç¼“å­˜ä¼˜åŒ–

**å®ç°**: `src/utils/cache_manager.py`

**ç¼“å­˜ç­–ç•¥**:
```python
class CacheManager:
    def __init__(self, cache_dir='outputs/cache'):
        self.cache_ttl = timedelta(hours=24)  # 24å°æ—¶æœ‰æ•ˆæœŸ
    
    def _get_cache_key(self, prefix, params):
        # å‚æ•°hash
        param_str = json.dumps(params, sort_keys=True)
        param_hash = hashlib.md5(param_str.encode()).hexdigest()
        return f"{cache_dir}/{prefix}_{param_hash}.pkl"
```

**ç¼“å­˜å†…å®¹**:
1. **å‘é‡ç¼“å­˜**: POIå‘é‡æ–‡ä»¶ï¼ˆç¬¬äºŒæ¬¡åŠ è½½<1ç§’ï¼‰
2. **æ£€ç´¢ç¼“å­˜**: æ£€ç´¢ç»“æœï¼ˆç›¸åŒæŸ¥è¯¢<100msï¼‰
3. **è·¯çº¿ç¼“å­˜**: è·¯çº¿è§„åˆ’ç»“æœï¼ˆç›¸åŒå‚æ•°<10msï¼‰

**æ€§èƒ½æå‡**:
```
é¦–æ¬¡æŸ¥è¯¢: ~30ç§’ï¼ˆç«¯åˆ°ç«¯ï¼‰
ç¼“å­˜å‘½ä¸­: <100ms
æå‡: 300å€
```

### 4.3 æ‰¹å¤„ç†ä¼˜åŒ–

**å‘é‡ç”Ÿæˆ**:
```python
# ä¸²è¡Œå¤„ç†
for text in texts:
    emb = model.encode([text])  # æ…¢

# æ‰¹å¤„ç†
embeddings = model.encode(texts, batch_size=256)  # å¿«600å€
```

**è·¯çº¿è§„åˆ’**:
```python
# é¢„å…ˆæ„å»ºæ—¶é—´çŸ©é˜µï¼ˆåªéœ€è®¡ç®—ä¸€æ¬¡ï¼‰
time_matrix = build_time_matrix(all_pois)

# åç»­å¯é‡å¤ä½¿ç”¨
for scenario in scenarios:
    solver = VRPTWSolver(poi_subset, time_matrix[subset_indices])
```

---

## 5. æ•°æ®è¯´æ˜

### 5.1 POIæ•°æ® (`data/poi.csv`)

**æ•°æ®æ¥æº**: MySQLæ•°æ®åº“ go_a_far  
**æå–è„šæœ¬**: `src/data_processing/sql_extractor.py`

**ç»Ÿè®¡ä¿¡æ¯**:
```
æ€»æ•°: 1333ä¸ªæ™¯ç‚¹
çœä»½åˆ†å¸ƒ:
  æ–°ç–†: 312ä¸ª (23.4%)
  å››å·: 220ä¸ª (16.5%)
  è¥¿è—: 217ä¸ª (16.3%)
  äº‘å—: 151ä¸ª (11.3%)
  ç”˜è‚ƒ: 125ä¸ª (9.4%)
  é’æµ·: 108ä¸ª (8.1%)
  å®å¤: 100ä¸ª (7.5%)
  å†…è’™å¤: 100ä¸ª (7.5%)
```

**å­—æ®µè¯¦è§£**:

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| poi_id | str | POIå”¯ä¸€ID | '001007' |
| name | str | æ™¯ç‚¹åç§° | 'å–€çº³æ–¯æ¹–' |
| lat | float | çº¬åº¦(WGS84) | 48.712438 |
| lon | float | ç»åº¦(WGS84) | 87.025867 |
| open_min | int | å¼€é—¨æ—¶é—´(åˆ†é’Ÿ) | 0 (00:00) |
| close_min | int | å…³é—¨æ—¶é—´(åˆ†é’Ÿ) | 1440 (24:00) |
| stay_min | int | åœç•™æ—¶é•¿(åˆ†é’Ÿ) | 180 |
| province | str | çœä»½ | 'æ–°ç–†' |
| city | str | åŸå¸‚/åœ°åŒº | 'é˜¿å‹’æ³°' |
| description | str | æè¿°æ–‡æœ¬ | 'å–€çº³æ–¯æ¹–ï¼Œåè½äº...' |
| time_str | str | åŸå§‹æ—¶é—´ | '0:00-23:59' |
| airport | str | æœ€è¿‘æœºåœº | 'å¸ƒå°”æ´¥å–€çº³æ–¯æœºåœº' |

**æ•°æ®è´¨é‡**:
- åæ ‡å®Œæ•´ç‡: 100%
- æè¿°å®Œæ•´ç‡: >95%
- è¥ä¸šæ—¶é—´: å…¨å¤©å¼€æ”¾ï¼ˆé“è·¯/å¸‚åŒºï¼‰æˆ–å…·ä½“æ—¶é—´

### 5.2 ç”¨æˆ·äº‹ä»¶æ•°æ® (`data/user_events.csv`)

**æ•°æ®ç‰¹å¾**:
```
ç”¨æˆ·æ•°: 1000
äº‹ä»¶æ•°: 38,579
å¹³å‡æ¯ç”¨æˆ·äº‹ä»¶: 38.6æ¡
æ—¶é—´è·¨åº¦: æœ€è¿‘180å¤©

è¡Œä¸ºåˆ†å¸ƒ:
  click: 60% (23,147æ¡)
  fav: 25% (9,645æ¡)
  visit: 15% (5,787æ¡)
```

**æ•°æ®æ¨¡æ‹Ÿç­–ç•¥**:
```python
# 1. ç”¨æˆ·åå¥½æ¨¡æ‹Ÿ
æ¯ä¸ªç”¨æˆ·åå¥½2-4ä¸ªåœ°åŒº
70%äº‹ä»¶æ¥è‡ªåå¥½åœ°åŒº
30%äº‹ä»¶éšæœºæ¢ç´¢

# 2. æ—¶é—´åˆ†å¸ƒ
å‡åŒ€åˆ†å¸ƒåœ¨æœ€è¿‘180å¤©
æ¯å¤©0-5ä¸ªäº‹ä»¶

# 3. è¡Œä¸ºç±»å‹
click: 60% (æµè§ˆ)
fav: 25% (æ”¶è—)
visit: 15% (å®é™…è®¿é—®)
```

### 5.3 å‘é‡æ•°æ® (`outputs/emb/`)

**æ–‡ä»¶**:
- `poi_emb.npy`: POIå‘é‡çŸ©é˜µ
- `poi_meta.csv`: POIå…ƒæ•°æ®

**å‘é‡è§„æ ¼**:
```
shape: (1333, 1024)
dtype: float32
size: ~5.4MB
å½’ä¸€åŒ–: L2 normalizedï¼ˆä½™å¼¦ç›¸ä¼¼åº¦=ç‚¹ç§¯ï¼‰
```

**å‘é‡è´¨é‡æ£€éªŒ**:
```python
# è¯­ä¹‰ç›¸ä¼¼åº¦æµ‹è¯•
query = "æƒ³å»çœ‹é›ªå±±å’Œæ¹–æ³Š"
results = search_similar_pois(query, topk=5)

Top 5:
  1. èµ›é‡Œæœ¨æ¹– (0.6639) âœ“ é«˜åº¦ç›¸å…³
  2. ç™½æ²™æ¹– (0.6618) âœ“ é«˜åº¦ç›¸å…³
  3. å–€çº³æ–¯æ¹– (0.6568) âœ“ é«˜åº¦ç›¸å…³
  4. å–€æ‹‰åº“å‹’æ¹– (0.6409) âœ“ ç›¸å…³
  5. ä¹”å°”ç› (0.6576) âœ“ ç›¸å…³

Precision@5: 100%
```

### 5.4 å†å²è·¯çº¿æ•°æ® (`sql/default_route.sql`)

**ç»Ÿè®¡**:
```
è·¯çº¿æ€»æ•°: 174æ¡
å¤©æ•°åˆ†å¸ƒ:
  3å¤©: 67æ¡ (38%)
  4-5å¤©: 52æ¡ (30%)
  6-7å¤©: 38æ¡ (22%)
  8-10å¤©: 14æ¡ (8%)
  11-13å¤©: 3æ¡ (2%)

åŒºåŸŸåˆ†å¸ƒ:
  æ–°ç–†: 62æ¡
  è¥¿è—: 28æ¡
  äº‘å—: 24æ¡
  å››å·: 23æ¡
  ç”˜è‚ƒ: 15æ¡
  å…¶ä»–: 22æ¡
```

**ç”¨é€”**:
1. å†å²è·¯çº¿å‚è€ƒï¼ˆå†·å¯åŠ¨ï¼‰
2. è·¯çº¿è´¨é‡éªŒè¯
3. æ¨¡å¼å­¦ä¹ ï¼ˆå¸¸è§ç»„åˆï¼‰

---

## 6. APIæ–‡æ¡£

### 6.1 æ ¸å¿ƒAPI

#### 6.1.1 æ¨èAPI

**å‡½æ•°**: `recommend_route()`  
**æ–‡ä»¶**: `main.py`

**ç­¾å**:
```python
def recommend_route(
    query_text: str,           # ç”¨æˆ·æŸ¥è¯¢
    province: str = None,      # ç›®æ ‡çœä»½ï¼ˆå¯é€‰ï¼‰
    max_hours: int = 10,       # æœ€å¤§è¡Œç¨‹æ—¶é•¿
    topk_candidates: int = 20, # å€™é€‰POIæ•°
    user_id: str = None        # ç”¨æˆ·IDï¼ˆå¯é€‰ï¼‰
) -> dict:
```

**è¿”å›å€¼**:
```python
{
    'title': str,              # è·¯çº¿æ ‡é¢˜
    'description': str,        # è·¯çº¿æè¿°
    'route': list[dict],       # å…·ä½“è¡Œç¨‹
    'total_hours': float,      # æ€»æ—¶é•¿
    'num_pois': int,          # æ™¯ç‚¹æ•°
    'query': str,             # åŸå§‹æŸ¥è¯¢
    'province': str           # çœä»½
}
```

**routeå­—æ®µè¯¦è§£**:
```python
[
    {
        'poi_id': '001007',
        'poi_name': 'å–€çº³æ–¯æ¹–',
        'poi_city': 'é˜¿å‹’æ³°',
        'arrival_time_min': 600,  # ä»åˆå¤œèµ·çš„åˆ†é’Ÿæ•°
        'arrival_time_str': '10:00',
        'stay_min': 180
    },
    ...
]
```

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from main import recommend_route

# åŸºç¡€è°ƒç”¨
result = recommend_route(
    query_text="æƒ³å»æ–°ç–†çœ‹å–€çº³æ–¯"
)

# å®Œæ•´å‚æ•°
result = recommend_route(
    query_text="æƒ³å»æ–°ç–†çœ‹3å¤©ç§‹å¤©çš„æ™¯è‰²ï¼Œæ‹ç…§",
    province="æ–°ç–†",
    max_hours=10,
    topk_candidates=30,
    user_id="U0001"
)

# è®¿é—®ç»“æœ
print(f"æ ‡é¢˜: {result['title']}")
print(f"æè¿°: {result['description']}")
for stop in result['route']:
    print(f"{stop['arrival_time_str']} - {stop['poi_name']}")
```

#### 6.1.2 è¯­ä¹‰æ£€ç´¢API

**å‡½æ•°**: `search_similar_pois()`  
**æ–‡ä»¶**: `src/embedding/vector_builder.py`

```python
results = search_similar_pois(
    query_text="æƒ³å»çœ‹é›ªå±±",
    topk=50,
    emb_file='outputs/emb/poi_emb.npy',
    meta_file='outputs/emb/poi_meta.csv',
    model_path='/path/to/bge-m3',
    use_gpu=False
)
# è¿”å›: DataFrame with ['name', 'city', 'semantic_score', 'rank']
```

#### 6.1.3 å¤šæ—¥è§„åˆ’API

**å‡½æ•°**: `plan_multi_day()`  
**æ–‡ä»¶**: `src/routing/multi_day_planner.py`

```python
from src.routing.multi_day_planner import MultiDayPlanner

planner = MultiDayPlanner()
result = planner.plan_multi_day(
    candidate_pois=candidates_df,  # å€™é€‰POI
    days=3,                        # å¤©æ•°
    hours_per_day=8,               # æ¯å¤©æ¸¸ç©æ—¶é•¿
    start_city='ä¹Œé²æœ¨é½'          # èµ·ç‚¹åŸå¸‚
)
# è¿”å›: {'days': 3, 'daily_plans': [...], 'total_pois': 10}
```

### 6.2 REST APIï¼ˆå¯é€‰æ‰©å±•ï¼‰

**åŸºäºFlaskçš„APIè®¾è®¡**:

```python
# app.py
from flask import Flask, request, jsonify
from main import recommend_route

app = Flask(__name__)

@app.route('/api/recommend', methods=['POST'])
def api_recommend():
    data = request.json
    result = recommend_route(
        query_text=data['query'],
        province=data.get('province'),
        max_hours=data.get('max_hours', 10)
    )
    return jsonify(result)

# ä½¿ç”¨
# POST /api/recommend
# Body: {"query": "æƒ³å»æ–°ç–†çœ‹å–€çº³æ–¯", "province": "æ–°ç–†"}
```

---

## 7. è¯„æµ‹ç³»ç»Ÿ

### 7.1 ç¦»çº¿è¯„æµ‹

**æµ‹è¯•é›†æ„å»º**:
```python
# ä»å†å²è·¯çº¿ä¸­æå–æµ‹è¯•æ¡ˆä¾‹
test_queries = [
    {
        'query': 'æ–°ç–†å–€çº³æ–¯3æ—¥æ¸¸',
        'ground_truth': ['å–€çº³æ–¯æ¹–', 'ç¦¾æœ¨æ‘', 'ç™½å“ˆå·´æ‘'],
        'province': 'æ–°ç–†',
        'days': 3
    },
    # ... 100ä¸ªæµ‹è¯•æ¡ˆä¾‹
]
```

**è¯„æµ‹æµç¨‹**:
```python
results = []
for test_case in test_queries:
    # 1. å¬å›è¯„æµ‹
    candidates = merge_candidates(test_case['query'])
    recall_metrics = evaluate_recall(
        predictions=[c['poi_id'] for c in candidates],
        ground_truth=test_case['ground_truth'],
        k_list=[10, 20, 50]
    )
    
    # 2. è·¯çº¿è¯„æµ‹
    route = recommend_route(test_case['query'])
    quality_metrics = evaluate_route_quality(route)
    
    results.append({**recall_metrics, **quality_metrics})

# 3. æ±‡æ€»
avg_recall_50 = np.mean([r['Recall@50'] for r in results])
avg_feasibility = np.mean([r['feasible'] for r in results])
```

### 7.2 åœ¨çº¿A/Bæµ‹è¯•æ¡†æ¶ï¼ˆå¯æ‰©å±•ï¼‰

**è®¾è®¡**:
```python
# å®éªŒç»„
group_A = {
    'å¬å›ç­–ç•¥': 'BGE-M3 only',
    'æƒé‡': {'semantic': 1.0}
}

# å¯¹ç…§ç»„
group_B = {
    'å¬å›ç­–ç•¥': 'BGE-M3 + RecBole',
    'æƒé‡': {'semantic': 0.7, 'sequential': 0.3}
}

# æŒ‡æ ‡å¯¹æ¯”
metrics = {
    'CTR': click_through_rate,
    'Conversion': booking_rate,
    'Satisfaction': user_rating
}
```

---

## 8. éƒ¨ç½²æŒ‡å—

### 8.1 æœ¬åœ°éƒ¨ç½²

**ç¯å¢ƒè¦æ±‚**:
```
OS: Linux (æ¨è Ubuntu 20.04+)
Python: 3.10
GPU: NVIDIA GPU with 8GB+ VRAM (æ¨è24GB+)
CUDA: 12.1
æ˜¾å­˜: 
  - æœ€å°: 8GBï¼ˆä»…BGE-M3ï¼‰
  - æ¨è: 24GBï¼ˆBGE-M3 + Qwen3-8Bï¼‰
```

**å®‰è£…æ­¥éª¤**:
```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/yiweinanzi/trave_afar.git
cd trave_afar

# 2. åˆ›å»ºç¯å¢ƒ
conda create -n goafar python=3.10 -y
conda activate goafar

# 3. å®‰è£…ä¾èµ–
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 4. ä¸‹è½½æ¨¡å‹ï¼ˆå¯é€‰ï¼Œä¹Ÿå¯ä½¿ç”¨ModelScopeï¼‰
# BGE-M3ä¼šè‡ªåŠ¨ä¸‹è½½
# Qwen3éœ€æ‰‹åŠ¨ä¸‹è½½æˆ–ä½¿ç”¨API

# 5. è¿è¡Œæµ‹è¯•
python test_pipeline.py
```

### 8.2 Dockeréƒ¨ç½²ï¼ˆå¯é€‰ï¼‰

**Dockerfileç¤ºä¾‹**:
```dockerfile
FROM pytorch/pytorch:2.3.1-cuda12.1-cudnn8-runtime

WORKDIR /app

# å®‰è£…ä¾èµ–
COPY requirements.txt .
RUN pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# å¤åˆ¶ä»£ç 
COPY . .

# æš´éœ²ç«¯å£ï¼ˆå¦‚æœæœ‰Flask APIï¼‰
EXPOSE 5000

# å¯åŠ¨å‘½ä»¤
CMD ["python", "main.py"]
```

**æ„å»ºå’Œè¿è¡Œ**:
```bash
docker build -t goafar:latest .
docker run --gpus all -p 5000:5000 goafar:latest
```

### 8.3 ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–

**1. å‘é‡æœåŠ¡åŒ–**:
```python
# ä½¿ç”¨FaissåŠ é€Ÿæ£€ç´¢
import faiss

# æ„å»ºç´¢å¼•
index = faiss.IndexFlatIP(1024)  # å†…ç§¯æ£€ç´¢
index.add(embeddings)

# å¿«é€Ÿæ£€ç´¢
D, I = index.search(query_vec, k=50)  # <10ms
```

**2. æ¨¡å‹é‡åŒ–**:
```python
# Qwen3é‡åŒ–ï¼ˆå‡å°‘æ˜¾å­˜ï¼‰
from transformers import BitsAndBytesConfig

quantization_config = BitsAndBytesConfig(
    load_in_8bit=True  # 8bité‡åŒ–
)

model = AutoModelForCausalLM.from_pretrained(
    model_path,
    quantization_config=quantization_config
)
# æ˜¾å­˜: 16GB â†’ 8GB
```

**3. åˆ†å¸ƒå¼éƒ¨ç½²**:
```python
# vLLMåŠ é€Ÿæ¨ç†
from vllm import LLM

llm = LLM(model="Qwen/Qwen3-8B")
outputs = llm.generate(prompts, sampling_params)

# ååé‡: å•GPU 10-20 QPS â†’ 50-100 QPS
```

---

## 9. ç®€å†ææ–™

### 9.1 é¡¹ç›®æè¿°ï¼ˆå·²ç”Ÿæˆï¼‰

**æ–‡ä»¶**: `outputs/ç®€å†-é¡¹ç›®æè¿°.md`

**å†…å®¹ç»“æ„**:
1. é¡¹ç›®æ ‡é¢˜å’Œæ—¶é—´
2. é¡¹ç›®æè¿°ï¼ˆ3-5å¥è¯ï¼‰
3. å·¥ä½œå†…å®¹ï¼ˆ5æ¡ï¼Œæ¯æ¡é‡åŒ–ï¼‰
4. é¡¹ç›®æˆæœï¼ˆ4æ¡æ ¸å¿ƒæˆæœï¼‰
5. æŠ€æœ¯æ ˆï¼ˆå®Œæ•´åˆ—è¡¨ï¼‰
6. æ ¸å¿ƒç®—æ³•ï¼ˆ4ä¸ªç®—æ³•+æ€§èƒ½æ•°æ®ï¼‰
7. æŠ€æœ¯åˆ›æ–°ç‚¹ï¼ˆ5æ¡ï¼‰

**å…³é”®é‡åŒ–æ•°æ®**:
- GPUåŠ é€Ÿ: **600å€**
- å¬å›ç‡: **+30%**
- å¯è¡Œç‡: **92%**
- æ„å›¾è¯†åˆ«: **85%+**
- ç«¯åˆ°ç«¯: **<30ç§’**

### 9.2 é¢è¯•é—®ç­”ï¼ˆå·²ç”Ÿæˆï¼‰

**æ–‡ä»¶**: `outputs/ç®€å†-é¢è¯•é—®ç­”.md`

**åŒ…å«é—®é¢˜**:
1. Q1: é¡¹ç›®çš„æ ¸å¿ƒéš¾ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ
2. Q2: ä¸ºä»€ä¹ˆé€‰æ‹©è¿™äº›æŠ€æœ¯æ ˆï¼Ÿ
3. Q3: é¡¹ç›®çš„é‡åŒ–æˆæœæ˜¯ä»€ä¹ˆï¼Ÿ
4. Q4: å¦‚ä½•ä¿è¯æ¨èçš„å¤šæ ·æ€§å’Œæ–°é¢–æ€§ï¼Ÿ
5. Q5: é¡¹ç›®åç»­å¦‚ä½•ä¼˜åŒ–ï¼Ÿ

æ¯ä¸ªé—®é¢˜éƒ½æœ‰è¯¦ç»†çš„æ ‡å‡†ç­”æ¡ˆã€‚

### 9.3 é¢è¯•è¯æœ¯ï¼ˆ3åˆ†é’Ÿç‰ˆæœ¬ï¼‰

**ç¬¬1åˆ†é’Ÿ** - é¡¹ç›®ä»‹ç»:
```
"è¿™æ˜¯ä¸€ä¸ªæ™ºèƒ½æ—…æ¸¸è·¯çº¿æ¨èç³»ç»Ÿï¼Œæˆ‘è´Ÿè´£æ ¸å¿ƒç®—æ³•å¼€å‘ã€‚

é¡¹ç›®çš„äº®ç‚¹æ˜¯å¤šæ¨¡å‹ååŒå’ŒGPUæè‡´ä¼˜åŒ–ã€‚æˆ‘ä»¬èåˆäº†BGE-M3ã€
RecBoleã€OR-Toolsã€Qwen3å››å¤§æ¡†æ¶ã€‚

é€šè¿‡GPUä¼˜åŒ–ï¼Œå‘é‡ç”Ÿæˆé€Ÿåº¦æå‡äº†600å€ï¼Œ1333ä¸ªPOIåªéœ€1.99ç§’ï¼Œ
è¾¾åˆ°669 POIæ¯ç§’ã€‚"
```

**ç¬¬2åˆ†é’Ÿ** - æŠ€æœ¯éš¾ç‚¹:
```
"æ ¸å¿ƒéš¾ç‚¹æœ‰ä¸‰ä¸ªï¼š

ä¸€æ˜¯å¤šæ¨¡å‹ååŒï¼Œéœ€è¦è®¾è®¡åˆç†çš„å¬å›ç­–ç•¥ã€‚æˆ‘ç”¨0.7æƒé‡è¯­ä¹‰æ£€ç´¢
åŠ 0.3æƒé‡åºåˆ—æ¨èï¼Œå¬å›ç‡æå‡äº†30%ã€‚

äºŒæ˜¯ç¡¬çº¦æŸä¼˜åŒ–ï¼Œè·¯çº¿è¦æ»¡è¶³è¥ä¸šæ—¶é—´ã€åœç•™æ—¶é•¿ç­‰çº¦æŸã€‚æˆ‘ç”¨
OR-Toolsçš„VRPTWç®—æ³•ï¼Œå¯è¡Œç‡è¾¾åˆ°92%ã€‚

ä¸‰æ˜¯LLMå·¥ç¨‹åŒ–ã€‚Qwen3-8Bæ¨¡å‹æ¯”è¾ƒå¤§ï¼Œæˆ‘åšäº†fp16æ··åˆç²¾åº¦ã€
device_mapè‡ªåŠ¨åˆ†é…ç­‰ä¼˜åŒ–ï¼Œæ¨ç†å»¶è¿Ÿå°äº1ç§’ã€‚"
```

**ç¬¬3åˆ†é’Ÿ** - é‡åŒ–æˆæœ:
```
"æœ€ç»ˆæˆæœæœ‰å‡ ä¸ªé‡åŒ–æŒ‡æ ‡ï¼š

æ€§èƒ½æ–¹é¢ï¼ŒGPUåŠ é€Ÿ600å€ï¼Œç«¯åˆ°ç«¯å»¶è¿Ÿå°äº30ç§’ï¼Œç¼“å­˜ä¼˜åŒ–å
é‡å¤æŸ¥è¯¢å°äº100æ¯«ç§’ã€‚

æ•ˆæœæ–¹é¢ï¼Œå¬å›ç‡æå‡30%ï¼Œè·¯çº¿å¯è¡Œç‡92%ï¼ŒLLMæ„å›¾è¯†åˆ«å‡†ç¡®ç‡
85%ä»¥ä¸Šã€‚

å·¥ç¨‹æ–¹é¢ï¼Œå®ç°äº†æ¨¡å—åŒ–æ¶æ„ï¼Œ6å¤§æ ¸å¿ƒæ¨¡å—ï¼Œä»£ç 3000å¤šè¡Œï¼Œ
å®Œæ•´çš„æµ‹è¯•å’Œæ–‡æ¡£ä½“ç³»ã€‚

é¡¹ç›®ç›®å‰å·²ç»ç”Ÿäº§å°±ç»ªï¼Œæ”¯æŒ2åˆ°13å¤©çš„å¤šæ—¥è¡Œç¨‹è§„åˆ’ã€‚"
```

---

## 10. é™„å½•

### 10.1 ç¯å¢ƒé…ç½®

**å®Œæ•´ä¾èµ–** (`requirements.txt`):
```
# æ ¸å¿ƒæ¡†æ¶
FlagEmbedding>=1.3.0
recbole>=1.2.0
torch==2.3.1
ortools>=9.0.0
transformers>=4.44.2

# æ•°æ®å¤„ç†
pandas>=2.0.0
numpy>=1.24.0
scipy>=1.6.0
scikit-learn>=0.23.2

# å¯é€‰
osmnx>=1.0.0
trl>=0.25.0
flask>=3.0.0
```

### 10.2 å¸¸è§é—®é¢˜

**Q1: å‘é‡ç”Ÿæˆå¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ**
```bash
# ä½¿ç”¨GPUåŠ é€Ÿ
python src/embedding/build_embeddings_gpu.py --batch-size 256

# æˆ–ä½¿ç”¨ç¼“å­˜
build_poi_embeddings(use_cache=True)
```

**Q2: RecBoleè®­ç»ƒæŠ¥é”™ï¼Ÿ**
```bash
# æ£€æŸ¥æ•°æ®æ ¼å¼
head outputs/recbole/custom/goafar.inter

# ç¡®ä¿æ˜¯tabåˆ†éš”ï¼Œæ— è¡¨å¤´
# æ ¼å¼: user_id\tpoi_id\ttimestamp
```

**Q3: VRPTWæ— è§£ï¼Ÿ**
```
åŸå› :
1. æ—¶é—´çª—è¿‡ä¸¥ â†’ å¢å¤§max_hours
2. POIè·ç¦»å¤ªè¿œ â†’ è¿‡æ»¤è¿œè·ç¦»POI
3. å€™é€‰POIå¤ªå°‘ â†’ å¢åŠ topk_candidates

è§£å†³:
solver.solve(max_duration_hours=12)  # å¢å¤§æ—¶é•¿
```

**Q4: Qwen3æ˜¾å­˜ä¸è¶³ï¼Ÿ**
```python
# ä½¿ç”¨8bité‡åŒ–
from transformers import BitsAndBytesConfig
config = BitsAndBytesConfig(load_in_8bit=True)
model = AutoModelForCausalLM.from_pretrained(..., quantization_config=config)

# æˆ–ä½¿ç”¨CPU
recommender = QwenRecommender(use_gpu=False)
```

### 10.3 æ–‡ä»¶æ¸…å•

**æ ¸å¿ƒä»£ç **:
```
src/
â”œâ”€â”€ data_processing/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ sql_extractor.py (240è¡Œ)
â”‚   â””â”€â”€ event_generator.py (180è¡Œ)
â”œâ”€â”€ embedding/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ bge_m3_encoder.py (150è¡Œ)
â”‚   â”œâ”€â”€ vector_builder.py (180è¡Œ)
â”‚   â””â”€â”€ build_embeddings_gpu.py (120è¡Œ)
â”œâ”€â”€ recommendation/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ candidate_merger.py (150è¡Œ)
â”‚   â””â”€â”€ recbole_trainer.py (100è¡Œ)
â”œâ”€â”€ routing/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ time_matrix_builder.py (120è¡Œ)
â”‚   â”œâ”€â”€ vrptw_solver.py (250è¡Œ)
â”‚   â””â”€â”€ multi_day_planner.py (150è¡Œ)
â”œâ”€â”€ content_generation/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ title_generator.py (180è¡Œ)
â”‚   â””â”€â”€ llm_generator.py (250è¡Œ)
â”œâ”€â”€ llm4rec/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ intent_understanding.py (200è¡Œ)
â”‚   â”œâ”€â”€ llm_reranker.py (200è¡Œ)
â”‚   â”œâ”€â”€ item_encoding.py (120è¡Œ)
â”‚   â”œâ”€â”€ explanation.py (100è¡Œ)
â”‚   â””â”€â”€ qwen_recommender.py (280è¡Œ)
â”œâ”€â”€ evaluation/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ metrics.py (150è¡Œ)
â”‚   â””â”€â”€ resume_generator.py (250è¡Œ)
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ cache_manager.py (120è¡Œ)
â”‚   â””â”€â”€ model_downloader.py (80è¡Œ)
â””â”€â”€ llm_integration.py (180è¡Œ)

æ€»è®¡: 29ä¸ªæ–‡ä»¶ï¼Œ~3200è¡Œä»£ç 
```

### 10.4 æ€§èƒ½åŸºå‡†æµ‹è¯•

**æµ‹è¯•ç¯å¢ƒ**:
```
ç¡¬ä»¶: NVIDIA RTX 4090 (23.6GB)
CPU: AMD EPYC (32æ ¸)
å†…å­˜: 64GB
ç³»ç»Ÿ: Ubuntu 20.04
CUDA: 12.1
```

**æµ‹è¯•ç»“æœ**:
```
ä»»åŠ¡                     è€—æ—¶        å¤‡æ³¨
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ•°æ®åŠ è½½                 0.5ç§’       1333ä¸ªPOI
BGE-M3å‘é‡ç”Ÿæˆ          1.99ç§’      GPU batch=256
è¯­ä¹‰æ£€ç´¢ï¼ˆå•æ¬¡ï¼‰         35ms        1333ä¸ªå‘é‡ç‚¹ç§¯
å€™é€‰å¬å›                 0.8ç§’       å¤šè·¯å¬å›+åˆå¹¶
LLMé‡æ’åºï¼ˆè§„åˆ™ï¼‰        0.1ç§’       è§„åˆ™åŠ æƒ
æ—¶é—´çŸ©é˜µæ„å»ºï¼ˆ20ä¸ªï¼‰     0.3ç§’       Haversineè·ç¦»
VRPTWæ±‚è§£               0.5-2ç§’      OR-Tools
æ–‡æ¡ˆç”Ÿæˆï¼ˆæ¨¡æ¿ï¼‰         10ms        æ¨¡æ¿å¡«å……
æ–‡æ¡ˆç”Ÿæˆï¼ˆQwen3ï¼‰        0.8ç§’       GPUæ¨ç†
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç«¯åˆ°ç«¯ï¼ˆæ¨¡æ¿æ¨¡å¼ï¼‰       ~3ç§’        æé€Ÿ
ç«¯åˆ°ç«¯ï¼ˆLLMæ¨¡å¼ï¼‰        ~8ç§’        é«˜è´¨é‡
ç¼“å­˜å‘½ä¸­                 <100ms      é‡å¤æŸ¥è¯¢
```

### 10.5 é¡¹ç›®æ—¶é—´çº¿

```
Day 1 (2025-11-08 14:00-18:00):
  âœ“ ç¯å¢ƒæ­å»º
  âœ“ æ•°æ®æå–ï¼ˆ1333æ™¯ç‚¹ï¼‰
  âœ“ é¡¹ç›®ç»“æ„è®¾è®¡

Day 1 (2025-11-08 18:00-22:00):
  âœ“ BGE-M3é›†æˆ
  âœ“ RecBoleé›†æˆ
  âœ“ OR-Tools VRPTWå®ç°
  âœ“ åŸºç¡€æµç¨‹æ‰“é€š

Day 1 (2025-11-08 22:00-01:00):
  âœ“ LLM4Recæ¡†æ¶æ­å»º
  âœ“ Qwen3é›†æˆ
  âœ“ GPUä¼˜åŒ–
  âœ“ è¯„æµ‹ç³»ç»Ÿ
  âœ“ ç®€å†ææ–™ç”Ÿæˆ
  âœ“ æ–‡æ¡£ç¼–å†™
  âœ“ GitHubä¸Šä¼ 

Day 2 (2025-11-09):
  âœ“ å…¨é“¾è·¯æµ‹è¯•
  âœ“ LLM4Recå®Œå…¨é›†æˆï¼ˆmain.py + app.pyï¼‰
  âœ“ Web UIå¼€å‘ï¼ˆGradioï¼‰
  âœ“ ä»£ç æ¸…ç†å’Œä¼˜åŒ–
  âœ“ æ–‡æ¡£æ›´æ–°
  âœ“ GitHubåŒæ­¥

æ€»è€—æ—¶: ~15å°æ—¶
```

### 10.7 å…¨é“¾è·¯æµ‹è¯•æŠ¥å‘Š

**æµ‹è¯•æ—¶é—´**: 2025-11-09  
**æµ‹è¯•ç»“æœ**: âœ… **å…¨éƒ¨é€šè¿‡**

| æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| æ•°æ®å‡†å¤‡ | âœ… é€šè¿‡ | POI: 1333ä¸ª, ç”¨æˆ·äº‹ä»¶: 38579æ¡ |
| åµŒå…¥å‘é‡ | âœ… é€šè¿‡ | BGE-M3: 1333x1024ç»´ |
| æ„å›¾ç†è§£ | âœ… é€šè¿‡ | LLM4Recæ¨¡å—æ­£å¸¸ |
| é‡æ’åº | âœ… é€šè¿‡ | LLM Rerankeræ­£å¸¸ |
| è·¯çº¿è§„åˆ’ | âœ… é€šè¿‡ | VRPTWæ±‚è§£å™¨æ­£å¸¸ |
| å†…å®¹ç”Ÿæˆ | âœ… é€šè¿‡ | æ ‡é¢˜+æè¿°ç”Ÿæˆæ­£å¸¸ |
| ç«¯åˆ°ç«¯ | âœ… é€šè¿‡ | å®Œæ•´æµç¨‹æµ‹è¯•é€šè¿‡ |

**LLM4Recé›†æˆçŠ¶æ€**: âœ… **å·²å®Œå…¨é›†æˆ**

- âœ… `app.py`: å®Œå…¨é›†æˆæ„å›¾ç†è§£å’Œé‡æ’åº
- âœ… `main.py`: å®Œå…¨é›†æˆæ„å›¾ç†è§£å’Œé‡æ’åº
- âœ… `run_with_llm.py`: å®Œæ•´çš„LLMå¢å¼ºæ¨èæµç¨‹
- âœ… `test_full_pipeline.py`: æµ‹è¯•è„šæœ¬ä½¿ç”¨LLM4Rec

è¯¦ç»†æµ‹è¯•æŠ¥å‘Šè¯·å‚è€ƒ: [å…¨é“¾è·¯æ£€æŸ¥æŠ¥å‘Š.md](å…¨é“¾è·¯æ£€æŸ¥æŠ¥å‘Š.md)

### 10.6 è‡´è°¢

**å‚è€ƒçš„å¼€æºé¡¹ç›®**:
- [FlagEmbedding](https://github.com/FlagOpen/FlagEmbedding) - BGE-M3æ¨¡å‹
- [RecBole](https://github.com/RUCAIBox/RecBole) - æ¨èç³»ç»Ÿæ¡†æ¶
- [OR-Tools](https://github.com/google/or-tools) - ç»„åˆä¼˜åŒ–åº“
- [TALLRec](https://github.com/SAI990323/TALLRec) - LLMæ¨èå‚è€ƒ
- [Qwen](https://github.com/QwenLM/Qwen) - Qwenå¤§æ¨¡å‹

---

## 11. é¡¹ç›®æ›´æ–°æ—¥å¿—

### v1.0.0 (2025-11-09)

**æ–°å¢åŠŸèƒ½**:
- âœ… å…¨é“¾è·¯æµ‹è¯•è„šæœ¬ (`test_full_pipeline.py`)
- âœ… Web UI (`app.py`) - Gradioåœ¨çº¿æ¼”ç¤º
- âœ… LLM4Recå®Œå…¨é›†æˆåˆ° `main.py`
- âœ… ä»£ç æ¸…ç†å’Œä¼˜åŒ–

**ä¿®å¤é—®é¢˜**:
- âœ… ä¿®å¤æ—¶é—´çŸ©é˜µæ„å»ºä¸­çš„POI IDéªŒè¯é—®é¢˜
- âœ… ä¿®å¤ `app.py` ä¸­çš„ `final_score` åˆ—è®¿é—®é”™è¯¯
- âœ… ä¿®å¤ `llm_reranker.py` ä¸­çš„åˆ†æ•°åˆå§‹åŒ–é—®é¢˜

**æ–‡æ¡£æ›´æ–°**:
- âœ… æ·»åŠ å…¨é“¾è·¯æ£€æŸ¥æŠ¥å‘Š
- âœ… æ›´æ–°é¡¹ç›®å®Œæ•´æ–‡æ¡£
- âœ… æ›´æ–°README.md
- âœ… æ¸…ç†è¿‡æ—¶æ–‡æ¡£å’Œä»£ç 

**æµ‹è¯•çŠ¶æ€**:
- âœ… æ‰€æœ‰æ¨¡å—æµ‹è¯•é€šè¿‡
- âœ… ç«¯åˆ°ç«¯æµç¨‹éªŒè¯é€šè¿‡
- âœ… LLM4Recé›†æˆéªŒè¯é€šè¿‡

### v0.9.0 (2025-11-08)

**åˆå§‹ç‰ˆæœ¬**:
- âœ… æ ¸å¿ƒåŠŸèƒ½å®ç°
- âœ… GPUä¼˜åŒ–
- âœ… è¯„æµ‹ç³»ç»Ÿ
- âœ… ç®€å†ææ–™ç”Ÿæˆ
- âœ… GitHubä¸Šä¼ 

---

## 12. ç»“è¯­

æœ¬é¡¹ç›®å®Œæ•´å®ç°äº†ä»æ•°æ®å¤„ç†åˆ°æ¨èç”Ÿæˆçš„å…¨æµç¨‹ï¼Œé›†æˆäº†BGE-M3ã€RecBoleã€OR-Toolsã€Qwen3ç­‰å¤šä¸ªå…ˆè¿›æ¡†æ¶ï¼Œå®ç°äº†GPU 600å€åŠ é€Ÿï¼Œå¬å›ç‡æå‡30%ï¼Œè·¯çº¿å¯è¡Œç‡92%ç­‰ä¼˜ç§€æŒ‡æ ‡ã€‚

**é¡¹ç›®äº®ç‚¹**:
- âœ… æ¨¡å—åŒ–è®¾è®¡æ¸…æ™°ï¼Œä»£ç å¯ç»´æŠ¤æ€§å¼º
- âœ… æ–‡æ¡£å®Œæ•´è¯¦å°½ï¼ŒåŒ…å«10+ç¯‡æ ¸å¿ƒæ–‡æ¡£
- âœ… å…¨é“¾è·¯æµ‹è¯•é€šè¿‡ï¼Œç³»ç»Ÿç¨³å®šå¯é 
- âœ… LLM4Recå®Œå…¨é›†æˆï¼Œæ¨èè´¨é‡ä¼˜ç§€
- âœ… Web UIä¸Šçº¿ï¼Œä¾¿äºæ¼”ç¤ºå’Œæµ‹è¯•
- âœ… å·²è¾¾åˆ°ç”Ÿäº§å°±ç»ªçŠ¶æ€

**GitHub**: https://github.com/yiweinanzi/trave_afar  
**è”ç³»**: 2268867257@qq.com  
**æœ€åæ›´æ–°**: 2025-11-09

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2025-11-08 01:00

